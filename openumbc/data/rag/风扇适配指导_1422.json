{
    "topic_id": 1422,
    "question": "风扇适配指导 - content: 一、thermal_mgmt介绍\n散热器件管理组件，提供散热器件状态监测、调速、异常告警和基础信息收集与展示的功能。\n代码目录结构\n\tdevice_tree:                                            --设备树相关实现\n      adapters:\n        14100363_0000000xxxxxxxxxxxxx                       --14100363_0000000xxxxxxxxxxxxx单板对应adapter实现\n        14100363_0000000xxxxxxxxxxxxx                       --14100363_0000000xxxxxxxxxxxxx单板对应adapter实现\n        thermal_common:\n            pwm_channel.lua:                                -- pwm_channel对象，用于描述共pwm通道场景\n            Fan.lua                                         -- 单风扇PWM设置默认实现\n            FanGroup.lua                                    -- 风扇组默认实现\n            Fans.lua                                        -- PWM批量下发默认实现\n            PumpGroup.lua                                   -- 泵组默认实现\nmanufacture：\n\tthermal_mgmt_manufacture.lua                            --装备测试项代码\nsrc:\n\tlualib:\n\t\tipmi_service:\n\t\t\tfan_ipmi.lua                                    --风扇ipmi实现\n\t\t\tvalve_ipmi.lua                                  --电磁阀ipmi实现\n\t\tbasic_cooling_config.lua                            --基础散热配置对象管理\n\t\tfan_group.lua                                       --风扇组对象管理\n\t    fan_info.lua                                        --faninfo对象管理\n\t\tfan_object.lua                                      --fan对象管理\n\t\tfan_service.lua                                     --风扇服务\n\t\tfan_type_object.lua                                 --fantype对象管理\n\t\tfans_object.lua                                     --fans对象管理\n\t\tmetric_collect.lua                                  --数据采集\n\t\tpower_supplies.lua                                  --电源风扇管理\n\t\tpump_object.lua                                     --pump对象管理\n\t\tpumps_object.lua                                    --pumps象管理\n\t\tthermal_mgmt_app.lua                                --app入口\n\t\tthermal_mgmt_utils.lua                              --散热组件工具函数实现\n\t\tvalve_enums.lua                                     --电磁阀枚举\n\t\tvalve_object.lua                                    --valve对象管理\n\t\tvalve_service.lua                                   --电磁阀服务\n\t\tvalves_object.lua                                   --valves对象管理\n\n二、风扇加载流程\n1、自发现识别加载CSR\n2、自发现上树ObejctGroup对象\n3、sd-bus发送InterfaceAdd信号给各个组件\n4、各个组件向自发现请求CSR对象（解析出来的CSR文本）\n5、libmc4lua创建资源树对象\n6、libmc4lua将自发现解析出来的属性赋值给对象\n7、libmc4lua从持久化恢复数据到对象上\n8、libmc4lua把对象注册上树\n9、调用各个组件的addobject回调\n10、执行组件设备树的差异性适配\n11、执行orm初始化回调，对象初始化完成\nimage946×861 31.1 KB\n三、风扇CSR适配\n1、配置风扇转速信息、在位信息、PWM信息（通常位于风扇板上）\n\"Scanner_Fan1_Presence\": {\n    \"Chip\": \"#/Smc_FanBoardSMC\",\n    \"Offset\": 402656001,\n    \"Size\": 1,\n    \"Mask\": 1,\n    \"Type\": 0,\n    \"Period\": 2000,\n    \"Debounce\": \"None\",\n    \"ScanEnabled\": \"<=/Scanner_PowerGood.Value\",\n    \"NominalValue\": 1,\n    \"@Default\": {\n      \"ScanEnabled\": 0\n    },\n      \"Value\": 0\n    }\n}\n\n\"Scanner_Fan1_FSpeed\": {\n      \"Chip\": \"#/Smc_FanBoardSMC\",                     # 关联的chip\n      \"Offset\": 402657025,                             # 偏移\n      \"Size\": 4,                                       # 读取数据长度\n      \"Mask\": 4294901760,                              # 位读时有效，从硬件读取数据后与掩码按位与操作\n      \"Type\": 0,                                       # 读类型，0：位读，1：块读\n      \"Period\": 1000,                                  # 扫描周期，单位ms\n      \"Debounce\": \"None\",                              # 防抖类型\n      \"Value\": 0                                       # 读值\n}\n\n\"Accessor_Fan1_PWM\": {\n    \"Chip\": \"#/Smc_FanBoardSMC\",                       # 关联的chip\n    \"Offset\": 402657281,                               # 偏移\n    \"Size\": 1,                                         # 读取数据长度\n    \"Mask\": 255,                                       # 位读时有效，从硬件读取数据后与掩码按位与操作\n    \"Type\": 0,                                         # 读类型，0：位读，1：块读\n    \"Value\": 0                                         # 读值\n}\n\n2、配置风扇chip（通常位于风扇板上，用作风扇板风扇PWM设置）\n\"Chip_Fan_PWM\": {\n    \"OffsetWidth\": 4,\n    \"AddrWidth\": 4,\n    \"Address\": 96\n}\n\nFans_0\": {\n    \"PWMChip\": \"#/Chip_Fan_PWM\",                          # 关联Chip对象\n    SetPWMCmd\": 402657792                                 # SMC命令\n}\n\n3、配置风扇CSR（通常位于风扇板上）\n\"Fan_1\": {\n    \"FanId\": 1,                                           # 风扇ID\n    \"Slot\": 1,                                            # 风扇槽位\n    \"FrontPresence\": \"<=/Scanner_Fan1_Presence.Value\",    # 前转子在位状态 1：在位；0：不在位\n    \"RearPresence\": \"<=/Scanner_Fan1_Presence.Value\",     # 后转子在位状态 1：在位；0：不在位\n    \"FrontSpeed\": \"<=/Scanner_Fan1_FSpeed.Value\",         # 前转子转速\n    \"RearSpeed\": \"<=/Scanner_Fan1_RSpeed.Value\",          # 后转子转速\n    \"HardwarePWM\": \"#/Accessor_Fan1_PWM.Value\",           # 硬件占空比 从硬件获取的占空比信息\n    \"SystemId\": 1,                                        # 系统Id\n    \"FrontStatus\": 0,                                     # 前转子状态 由软件进行刷新\n    \"RearStatus\": 0,                                      # 后转子状态 由软件进行刷新\n    \"MaxSupportedPWM\": 255,                               # 该风扇支持的最大占空比\n    \"IdentifySpeedLevel\": 35,                             # 风扇型号识别时使用的转速级别\n    \"Position\": \"CLU${Slot}\",                             # 风扇的位置 如 CLU1\n    \"PowerGood\": \"<=/Scanner_PowerGood.Value\"             # OS上下电信息\n}\n\"FanType_1\": {\n      \"Name\": \"8038+\",                                    # 风扇型号\n      \"Index\": 1,                                         # 风扇型号的索引 \n      \"IsTwins\": true,                                    # 是否为双转子风扇\n      \"FrontMaxSpeed\": 15000,                             # 前转子最大转速\n      \"RearMaxSpeed\": 15000,                              # 后转子最大转速\n      \"IdentifyRangeLow\": 3230,                           # 风扇型号识别转速左区间\n      \"IdentifyRangeHigh\": 4750,                          # 风扇型号识别转速右区间\n      \"PartNumber\": \"02314BLG\",                           # 部件编码\n      \"BOM\": \"BOM32030275\",                               # BOM编码\n      \"SystemId\": 1                                       # 系统Id\n}                 \n\n5、调试\n例：风扇4后转子转速查询\nbusctl --user call bmc.kepler.hwproxy /bmc/kepler/Chip/Smc/Smc_FanBoardSMC_010103 bmc.kepler.Chip.BlockIO Read a{ss}uu 0 0x18000F04 2\nay 2 236 4\n解释：/bmc/kepler/Chip/Smc/Smc_FanBoardSMC_010103：对应Chip的资源树路径（根据环境上路径进行调整）\nbmc.kepler.Chip.BlockIO：资源树块读写接口\nRead：方法名\na{ss}uu：请求参数签名，其中a{ss}为上下文可以直接填0，第一个u代表偏移，第二个u代表读取字节数\n236 = 0xEC\n则转速为:0x04EC = 1260\n四、风扇设备树适配\n风扇板差异，风扇转速设置方式可能有所不同，如共PWM通道场景，通过设备树在不同风扇板下实现该差异性。设备树加载通用模型，与通用逻辑不一致的需要自行在对应的csr目录下补充adapter, 在init()函数中声明各接口\nimage514×228 4.29 KB\n1、Fan\n提供接口如下\n\n接口\n描述\n\nSetFanExpectedPWM\n设置期望占空比\n\nSetFanPWM\n设置风扇占空比 （校验风扇是否在位且型号已识别）\n\nSetFanHardwarePWM\n设置风扇占空比 （无校验）\n\nConfigurable\n风扇是否在位且型号已识别\n\n2、Fans\n提供接口如下\n\n接口\n描述\n\nSetFansPWM\n批量设置风扇占空比\n\n五、风扇型号加载流程\n风扇型号识别备选池由配置的FanType对象决定。通过Fan对象下配置的IdentifySpeedLevel属性明确该风扇风扇识别时的使用的PWM，当设置该PWM下，风扇转速处于FanType IdentifyRangeLow与IdentifyRangeHigh之间，则认为风扇类型为该FanType\nimage601×1152 28.9 KB\n六、常见踩坑点及注意事项\n1、风扇转速下发不生效\n可优先设置手动模式后，使用smc命令进行占空比下发与查询排除CSR配置问题\n（1）设置手动模式\nipmcset -d fanmode -v 1 0\nSet fan mode successfully.\nCurrent Mode:       manual\nTime out    :       100000000 seconds\n\n（2）占空比设置\nmdbctl call Smc_FanBoardSMC_010103 bmc.kepler.Chip.BlockIO Write 0 0x18001000 \n4 254 254 254 254\n\n（3）占空比查询\nmdbctl call Smc_FanBoardSMC_010103 bmc.kepler.Chip.BlockIO Read 0 0x18001100 4\n[89,89,89,89]\n\n2、风扇类型识别错误\n关键日志\nidentify fan%d model successfully. identify_cnt = %d. record_pwm = [%s], record_speed = [%s]\n\nrecord_pwm 应当每个都是MaxSupportedPWM * IdentifySpeedLevel，record_speed应当每个都在预期的IdentifyRangeLow和IdentifyRangeHigh之间。\n如果record_pwm 符合预期但是record_speed不符合预期，则是硬件问题。如果record_pwm出现不一致的或者不是MaxSupportedPWM * IdentifySpeedLevel的，可能问题点：\n1.thermal_mgmt软件问题，需要排查是否在风扇转速识别过程中没正确拦截其余PWM设置任务，识别风扇型号PWM被覆盖\n2.Accessor_Fan1_PWM寄存器无法写入\n3.框架上报的值错误，可以手动读寄存器与资源树上的值进行对比\nlinks: #p-3319-thermal_mgmt-1, #p-3319-h-2, #p-3319-h-3, https://discuss.openubmc.cn/uploads/default/original/2X/8/87a15274c68db2e496e1e05e3dae3256ac20b595.png, #p-3319-csr-4, #p-3319-h-5, https://discuss.openubmc.cn/uploads/default/original/2X/f/f6bcaa275b520277263bbd536f37c03ca96e34e3.png, #p-3319-h-1fan-6, #p-3319-h-2fans-7, #p-3319-h-8, https://discuss.openubmc.cn/uploads/default/original/2X/c/cd843ac1df098b27b76ff7fa18641f883d233f49.png, #p-3319-h-9",
    "topic_user_name": "Weber Chen",
    "best_answer_url": "",
    "reply_posts": []
}