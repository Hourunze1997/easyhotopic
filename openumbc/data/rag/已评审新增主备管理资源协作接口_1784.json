{
    "topic_id": 1784,
    "question": "【已评审】新增主备管理资源协作接口 - content: ISSUE\n【需求】支持主备状态切换条件检测功能\n评审背景\n需求分析\n\nBMC要支持框式设备的管理，在框式设备中一般存在多个节点，多个节点上的BMC有主备关系。因此BMC需要新增主备管理功能，需要提供资源协作接口用于支持查询/倒换主备状态。\n\n每个BMC上需要抽象出两类对象：本端BMC和远端BMC。每个BMC都需要体现BMC的唯一标识、主备状态等基本信息，以及节点之间通信需要的端口/地址配置。其中 BMC的唯一标识用于在初始状态下指定哪个BMC为主的场景。\n\n评审点\n评审点1：新增 本端BMC 主备管理资源\npath（新增）： /bmc/kepler/Managers/:ManagerId/ActiveStandby/Local\ninterface（新增）： 2个，分别如下：\n\n接口1：bmc.kepler.Managers.ActiveStandby.Status，属性如下：\n\n属性名称\n数据类型\n读写权限\n持久化\n信号\n说明\n\nActiveStatus\ny\n只读R:ReadOnly\n否\n是\n描述:当前BMC的主备状态数据源:内部更新取值范围1: Active 0: Standby默认值:0\n\nCommunicationStatus\ny\n只读R:ReadOnly\n否\n是\n描述:当前BMC的通信状态数据源:内部更新取值范围:1: 正常 0: 中断默认值:1\n\n接口2：bmc.kepler.Managers.ActiveStandby.Local\n新增属性如下：\n\n属性名称\n数据类型\n读写权限\n持久化\n信号\n说明\n\nId\ny\n只读R:ReadOnly\n否\n否\n描述:唯一标识，用于标识主备管理BMC数据源:产业配置取值范围:0~255默认值:0\n\nActiveAllowed\nb\n只读R:ReadOnly\n否\n否\n描述:当前BMC是否允许切换为主数据源:内部更新取值范围:true: 允许 false: 禁止默认值:false\n\nStandbyAllowed\nb\n只读R:ReadOnly\n否\n否\n描述:当前BMC是否允许切换为备数据源:内部更新取值范围:true: 允许 false: 禁止默认值:false\n\n新增方法如下：\n\n项目\n说明\n\n方法名\nSwitchStatus\n\n方法描述\n切换主备方向\n\n权限\nBascSetting\n\n请求签名\ny\n\n请求说明\nStatus:切换目标状态(取值:0:Standby 1:Active)\n\n响应签名\n–\n\n响应说明\n切换成功无响应内容，失败则抛出错误引擎异常\n\n私有属性如下：\n\n属性名称\n数据类型\n持久化\n说明\n\nPresence\ny\n否\n描述:BMC所在硬件板卡在位状态数据源:CSR配置取值范围:1: 在位 0: 不在位默认值:1\n\nAddress\ns\n否\n描述: BMC节点之间通信的地址数据源:CSR配置\n\nPort\nq\n否\n描述:BMC节点之间通信的端口数据源:CSR配置默认值:51000\n\n配置示例\n\"ActiveStandbyLocal_0\": {\n  \"Id\": 1,\n  \"Presence\": \"#/Object.Presence\",\n  \"Address\": \"192.168.100.114\",\n  \"Port\": 52000\n}\n\n评审点二：新增 远端BMC 主备管理资源\npath（新增）： /bmc/kepler/Managers/:ManagerId/ActiveStandby/Remotes/:RemoteId\ninterface（新增）： 2个，分别如下：\n\n接口1：bmc.kepler.Managers.ActiveStandby.Status，属性同 本端BMC 主备管理资源\n\n接口2：bmc.kepler.Managers.ActiveStandby.Remote， 属性如下：\n\n属性名称\n数据类型\n读写权限\n持久化\n信号\n说明\n\nId\ny\n只读R:ReadOnly\n否\n否\n描述:唯一标识，用于标识主备管理BMC数据源:产业配置取值范围:0~255\n\n私有属性如下：\n\n属性名称\n数据类型\n持久化\n说明\n\nPresence\ny\n否\n描述:BMC所在硬件板卡在位状态数据源:CSR配置取值范围:1: 在位 0: 不在位默认值:1\n\nAddress\ns\n否\n描述:BMC节点之间通信的地址数据源:CSR配置\n\nPort\nq\n否\n描述:BMC节点之间通信的端口数据源:CSR配置默认值:51000\n\n配置示例\n\"ActiveStandbyRemote_0\": {\n \"Id\": 2,\n \"Presence\": \"#/Object.Presence\",\n \"Address\": \"192.168.100.114\",\n \"Port\": 52000\n}\n\n评审点三：新增 主备BMC切换条件资源\n背景\n\n场景1：对于单板存在导致无法继续作为主设备进行管理的情况，比如严重告警\n场景2：对于特定的场景无法执行BMC的主备倒换，比如PSU的升级场景\n\n在特定的条件下，BMC的主备状态必须进行主动切换，或者禁止切换，需要通过统一的模型进行定义和支撑产业配置，因此需要增加 主备BMC切换条件模型资源。\n约束： 当多个条件同时满足时禁止条件的优先级高于主动切换的优先级\npath（新增）： /bmc/kepler/Managers/:ManagerId/ActiveStandby/SwitchRules/:Id\ninterface（新增）： bmc.kepler.Managers.ActiveStandby.SwitchRule，属性如下：\n\n属性名称\n类型\n读写权限\n持久化\n信号\n说明\n\nRuleType\ny\n只读R:ReadOnly\n否\n否\n描述:切换条件类型数据源:产业配置取值范围:0: BMC主动切换的触发条件 1: BMC被动切换的禁止条件 默认值:0\n\nThreshold\nu\n只读R:ReadOnly\n否\n否\n描述:当前主备切换条件的门限值数据源:产业配置默认值:1\n\nReading\nu\n读写R:ReadOnlyW:ReadOnly\n否\n否\n描述:当前主备切换条件的输入值数据源:产业配置默认值:0\n\nEnabled\nb\n读写R:ReadOnlyW:BasicSetting\n否\n否\n描述:是否使能当前主备切换条件数据源:产业配置默认值:true\n\nOperator\ny\n只读R:ReadOnly\n否\n否\n描述:当前主备切换条件的运算符数据源:产业配置取值范围: 1：小于2：小于等于3：大于4：大于等于5：等于6：不等于默认值:5\n\nDirection\ny\n只读R:ReadOnly\n否\n否\n描述:切换条件类型配置为0时表示BMC主动切换的主备方向，配置为1时表示被动切换时被禁止的主备方向数据源:产业配置取值范围: 0：降备 1：升主 默认值:0\n\nDescription\ns\n只读R:ReadOnly\n否\n否\n描述:当前主备切换条件匹配之后的描述信息，表示BMC发生主动切换或者被动切换禁止的原因数据源:产业配置默认值:“”\n\n配置示例\n\"SwitchOverRule_0\": {\n \"RuleType\": 1,\n \"Threshold\": 1,\n \"Reading\": \"<=/Scanner_CPLD1.Value\",\n \"Operator\": 5,\n \"Enabled\": true,\n \"Direction\": 0,\n \"Description\": \"CPLD Validating\"\n}\n\n评审点四：新增 BMC主备服务 管理私有类 ActiveStandbyService\n背景\nBMC主备服务需要读取主备管理相关的一系列硬件信号，以及辅助BMC主备服务需要的属性。当前属性全部采用私有的方式进行管理。具体属性如下：\n\n属性名称\n类型\n持久化\n说明\n\nDefaultActiveId\ny\n否\n描述:默认单板的标识，与主备对象的Id对应数据源:CSR配置取值范围:0~255 默认值:1\n\nStandbyToActiveWrite\ny\n否\n描述:升主写入硬件信号对象数据源:CSR配置\n\nActiveToStandbyWrite\ny\n否\n描述:降备写入硬件信号对象数据源:CSR配置\n\nStandbyToActiveWriteProtect\ny\n否\n描述:升主写保护硬件信号对象数据源:CSR配置\n\nActiveToStandbyWriteProtect\ny\n否\n描述:降备写保护硬件信号对象数据源:CSR配置\n\nHeartbeatWrite\ny\n否\n描述:当前BMC主备心跳写入硬件信号对象数据源:CSR配置\n\nHealthStatusRead\ny\n否\n描述:当前BMC健康状态读取硬件信号对象数据源:CSR配置\n\nActiveRead\ny\n否\n描述:当前BMC主备状态读取硬件信号对象数据源:CSR配置\n\nBoardInRead\ny\n否\n描述:单板插稳状态读取对象数据源:CSR配置\n\nHeartbeatIntervalMS\nq\n否\n描述:当前BMC主备心跳检测周期，单位：ms数据源:CSR配置取值范围:10~1000默认值:300\n\nHeartbeatTimeoutMS\nq\n否\n描述:当前BMC主备心跳检测间隔的超时时间，单位：ms数据源CSR配置取值范围:500~3000默认值:3000\n\nActiveMonitorIntervalMS\nq\n否\n描述:当前BMC主备检测间隔，单位：ms数据源:CSR配置取值范围:50~300默认值:200\n\n配置示例\n\n\"ActiveStandbyService_0\": {\n  \"DefaultActiveId\": 1, # 默认框内1号BMC为主BMC\n  \"StandbyToActiveWrite\": \"#/Accessor_ToActive.Value\",\n  \"ActiveToStandbyWrite\": \"#/Accessor_ToStandby.Value\",\n  \"StandbyToActiveWriteProtect\": \"#/Accessor_ToActivePro.Value\",\n  \"ActiveToStandbyWriteProtect\": \"#/Accessor_ToStandbyPro.Value\",\n  \"HeartbeatWrite\": \"#/Accessor_Heartbeat.Value\",\n  \"HealthStatusRead\": \"#/Scanner_Health.Value\",\n  \"ActiveRead\": \"#/Scanner_Active.Value\",\n  \"BoardInRead\": \"#/Scanner_BoardIn.Value\",\n  \"HeartbeatIntervalMS\": 300,\n  \"HeartbeatTimeoutMS\": 3000,\n  \"StatusIntervalMS\": 200\n}\n\n评审点五：新增错误引擎 ForceFailoverError\n背景\n主备倒换失败时（例如redfish接口）需要展示异常信息，资源协作接口调用失败时抛出\n\n项目\n值\n\n错误引擎标识\nForceFailoverError\n\n变化类型\n新增\n\n错误描述\nAn error occurred during the force failover process.\n\n错误消息\nAn error occurred during the force failover process. Details: %1.\n\n参数类型\nstring\n\n处理建议\nLocate the cause based on error information, rectify the fault, and submit the request again.\n\n严重程度\nWarning\n\nHTTPCode\n400\n\nIPMICode\n不涉及\n\nSNMPCode\n不涉及\n\n示例\n    \"ForceFailoverError\": {\n      \"Description\": \"An error occurred during the force failover process.\",\n      \"Message\": \"An error occurred during the force failover process. Details: %1\",\n      \"Severity\": \"Warning\",\n      \"NumberOfArgs\": 1,\n      \"ParamTypes\": [\n        \"string\"\n      ],\n      \"Resolution\": \"Locate the cause based on error information, rectify the fault, and submit the request again.\",\n      \"HttpStatusCode\": 400,\n      \"IpmiCompletionCode\": \"0xFF\",\n      \"SnmpStatusCode\": 5,\n      \"TraceDepth\": 0\n    }\n\n评审结论\n\n评审点1：通过，同意新增资源协作接口 bmc.kepler.Managers.ActiveStandby.Status 和 bmc.kepler.Managers.ActiveStandby.Local，以及对应属性（见评审点）；同意新增资源路径 /bmc/kepler/Managers/:ManagerId/ActiveStandby/Local 以及私有属性（见评审点）\n评审点2：通过，同意新增资源协作接口 bmc.kepler.Managers.ActiveStandby.Remote 以及对应属性（见评审点）；同意新增资源路径/bmc/kepler/Managers/:ManagerId/ActiveStandby/Remotes/:RemoteId 以及私有属性（见评审点）\n评审点3：通过，同意新增资源协作接口 bmc.kepler.Managers.ActiveStandby.SwitchRule 以及对应属性（见评审点）；同意新增资源  /bmc/kepler/Managers/:ManagerId/ActiveStandby/SwitchRules/:Id\n评审点4：通过，同意新增 BMC主备服务 管理私有类 ActiveStandbyService 以及私有属性（见评审点）\n评审点5：通过，同意新增错误引擎 ForceFailoverError\nlinks: #p-4367-issue-1, https://gitcode.com/openUBMC/active_standby_mgmt/issues/4, #p-4367-h-2, #p-4367-h-3, #p-4367-h-4, #p-4367-h-1-bmc-5, #p-4367-bmc-6, #p-4367-bmc-7, #p-4367-h-8, #p-4367-bmc-activestandbyservice-9, #p-4367-h-10, #p-4367-forcefailovererror-11, #p-4367-h-12, #p-4367-h-13",
    "topic_user_name": "sunpeijun",
    "best_answer_url": "/t/topic/1784/2",
    "reply_posts": [
        {
            "user_name": "pengqiang",
            "topic_closed": true,
            "is_solution": true,
            "post_url": "/t/topic/1784/2",
            "text": "content: spjisgood_2lbdb:\n\n新增当前BMC对象ActiveStandbyLocal\npath /bmc/kepler/Managers/:ManagerId/ActiveStandby/Local\ninterfacebmc kepler.Managers.ActiveStandby\n备选1\npath /bmc/kepler/Managers/:ManagerId/ActiveStandby/Local\ninterfacebmc kepler.Managers.ActiveStandby.Local\n备选2\npath /bmc/kepler/Managers/:ManagerId/ActiveStandby/Active\ninterfacebmc kepler.Managers.ActiveStandby.Active\n\n@spjisgood_2lbdb 当前帖子评审之前需要关闭以下问题：\n问题1：评审点1中修复笔误问题，突出推荐方案，以及属性名称说明中补充CSR配置的属性的默认值\n问题2：Remote 资源中缺少对应的主备状态等基本属性，需要补齐；属性CSR配置中去掉对应的示例，由整体对象示例进行承载\n问题3：私有对象 SwitchOverRule 建议上资源树，后续演进对于主备切换场景支持北向接口展示以及社区/产业的动态调整\nlinks: /u/spjisgood_2lbdb"
        },
        {
            "user_name": "sunpeijun",
            "topic_closed": true,
            "is_solution": false,
            "post_url": "/t/topic/1784/3",
            "text": "根据评审中提出的问题，现做如下修改\n\nStatusIntervalMS 命名无法体现主备状态\n更改： 属性名修改为ActiveMonitorIntervalMS\nHeatbeatStatus描述存在歧义，且暂无周边消费，无上资源协作接口的必要\n更改： 此属性改为私有属性"
        }
    ]
}