{
    "topic_id": 406,
    "question": "busybox作为conan组件编入openUBMC实践分享 - content: 在开发ipmb相关功能时，需要使用devmem修改相关寄存器，但是openUBMC没有携带devmem程序，经过指导可以将busybox作为conan组件编入openUBMC，从而在openUBMC中使用busybox的devmen功能。\n1、新建busybox组件目录\n创建原始的conan组件，由于使用的是第三方开源软件，所以不需要通过bmcgo创建。\nimage192×191 4.38 KB\nconan文件相关概念，具体查看官方文档\nconanfile.py：定义 Conan 包的元数据（如名称、版本、许可证）、依赖关系、构建配置、编译选项等，是 Conan 包的核心配置文件、\n#!/usr/bin/python\n#-*-coding:utf-8-*-\nimport os\n\nfrom conans import ConanFile, tools, AutoToolsBuildEnvironment\n\nclass busyboxConan(ConanFile):\n    name = \"busybox\"\n    license = \"Mulan PSL v2\"\n    description = \"The SoftWare Freedom Conservancy acts as the GPL enforcement agent for various BusyBox\"\n    settings = \"os\", \"compiler\", \"build_type\", \"arch\"\n    requires = []\n    _env_build = None\n    generators = \"make\"\n    _cmake = None\n    options = {\"devmem\": [True, False]}\n    default_options = {\"devmem\": True}\n\n    @property\n    def _source_subfolder(self):\n        return \"source_subfolder\"\n\n    def source(self):\n        git = tools.Git(verify_ssl=False)\n        git.clone(**self.conan_data[\"sources\"][self.version])\n\n    def build(self):\n        autotools = AutoToolsBuildEnvironment(self)\n        chost = os.environ.get(\"CHOST\")\n        if chost is not None:\n            os.environ[\"CROSS_COMPILE\"] = chost + \"-\"\n        autotools.make(target=\"defconfig\")\n\n        # 开启 devmem\n        if self.options.devmem:\n            os.system(\"sed -i 's/# CONFIG_DEVMEM is not set/CONFIG_DEVMEM=y/' .config\")\n\n        autotools.make()\n    \n    def package(self):\n        self.copy(\"busybox\", dst=\"opt/debug\")\n\nconandata.yml：存储依赖库的版本范围、构建选项等元数据\nsources:\n  \"1.34.1\":\n    url: \"https://github.com/mirror/busybox.git\"\n    branch: \"1_34_stable\"\n    shallow: true\n\n2、创建本地busybox组件\n再目录下执行命令，创建本地组件，要带上build_type=Debug，bmcgo publish默认出Debug包\nconan create . busybox/1.34.1@hw.ibmc.release/rc -s build_type=Debug\n\n3、上传本地busybox组件到远程conan仓\nconan upload busybox/1.34.1@hw.ibmc.release/rc --all -r=ibmc_dev\n\nimage410×156 3.39 KB\n4、验证busybox组件\n清除本地缓存后，验证能否从远程下载\nconan install busybox/1.34.1@hw.ibmc.release/rc -r=ibmc_dev\n\n确保 Options 设置正确，导出table.html浏览器查看\nconan search busybox/1.34.1@hw.ibmc.release/rc -r=ibmc_dev --table=table.html\n\n5、manifest引用busybox组件\n  - conan: byo_general/0.0.1@hw.ibmc.common/rc\n  - conan: busybox/1.34.1@hw.ibmc.release/rc\n    options:\n          devmem: true\n\n6、ssh中使用busybox\nopt/debug/busybox ifconfig\nopt/debug/busybox devmem\n...\n\n7、其他组件使用busybox devmem\n在ssh中使用opt/debug/busybox devmem会提示权限错误，猜测是Administrator用户权限问题，经过实践，可改在其他组件服务中调用。\n[Service]\nUser=root\nRestart=always\nRestartSec=1\nStartLimitInterval=0\nEnvironmentFile=/dev/shm/dbus/.dbus\nEnvironment=\"ROOT_DIR=\"\nEnvironment=\"PROJECT_DIR=\"\nWorkingDirectory=/opt/bmc/apps/byo_709bmc\nExecStartPre=/opt/debug/busybox touch /tmp/ipmb\nExecStartPre=/opt/debug/busybox devmem 0x08745044 w 3\nExecStartPre=/opt/debug/busybox devmem 0x08745048 w 3\nExecStartPre=/opt/debug/busybox devmem 0x0874504c w 3\nExecStartPre=/opt/debug/busybox devmem 0x08745050 w 3\nExecStartPre=/opt/debug/busybox devmem 0x0871d334 w 0x00007f6\nExecStartPre=/bin/sh -c \"/opt/debug/busybox devmem 0x08745044 >> /tmp/ipmb\"\nExecStartPre=/bin/sh -c \"/opt/debug/busybox devmem 0x08745048 >> /tmp/ipmb\"\nExecStartPre=/bin/sh -c \"/opt/debug/busybox devmem 0x0874504c >> /tmp/ipmb\"\nExecStartPre=/bin/sh -c \"/opt/debug/busybox devmem 0x08745050 >> /tmp/ipmb\"\nlinks: #p-743-h-1busybox-1, https://forum.openubmc.cn/uploads/default/original/1X/18ca1b7361282a1f6bad09e22a5b84c3440a974c.png, #p-743-h-2busybox-2, #p-743-h-3busyboxconan-3, https://forum.openubmc.cn/uploads/default/original/1X/be28bf8202075ea376a3de14516e09dddda72b5c.png, #p-743-h-4busybox-4, #p-743-h-5manifestbusybox-5, #p-743-h-6sshbusybox-6, #p-743-h-7busybox-devmem-7",
    "topic_user_name": "南京百敖",
    "best_answer_url": "",
    "reply_posts": [
        {
            "user_name": "xuhaijun",
            "topic_closed": null,
            "is_solution": false,
            "post_url": "/t/topic/406/2",
            "text": "点赞，有几点小建议：\n1、manifest.yml引入busybox时由debug_dependencies描述依赖（而不是dependencies），debug_dependencies依赖只在个人构建时才会集成。主要考虑busybox带了不安全的telnet、tftp等协议，安装到产品包中有安全风险。\n2、建议将busybox构建脚本合入到gitcode/openUBMC/conan_index。\n3、默认安装telnetd服务，这样集成busybox组件的软件包启动时就能自动开启telnet，方便调试。"
        },
        {
            "user_name": "南京百敖",
            "topic_closed": null,
            "is_solution": false,
            "post_url": "/t/topic/406/3",
            "text": "好的，我先来看看conan_index怎么合入"
        }
    ]
}