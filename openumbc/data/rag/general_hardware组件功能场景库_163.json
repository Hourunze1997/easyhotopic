{
    "topic_id": 163,
    "question": "general_hardware组件功能场景库 - content: general_hardware组件功能场景库\n概述\n本文档详细描述了general_hardware组件中关键功能场景的实现及细节，涵盖固件升级、固件信息管理、板卡信息管理及相关告警等功能，这些功能场景是高频使用的，因此需保证稳定性和可靠性。\n\n一. 固件升级管理\n功能描述\n（1）CPLD、MCU、CSR、VRD、FPGA、Retimer等固件的升级逻辑；\n（2） 各固件信息管理，用于redfish、web界面显示；\n1、CPLD固件升级\n\nCPLD描述：全英文名称为Complex Programming logic device，中文为复杂可编程逻辑器件，是一种用于实现特定逻辑功能的硬件设备。\nCPLD所在板卡类型：BCU（基础板）、EXU（扩展板）、SEU（硬盘背板）、CLU（风扇板）等。\n\n1.1、 升级对象下发\n\n板卡支持CPLD固件升级，只需要在遵循天池规范的CSR增加自描述信息，且CPLD升级对象为LogicFirmware_xxx，自发现组件会在初始化阶段将对象下发到general_hardware，组件侧保存升级对象，后续即可支持对应CPLD固件的带外升级。\n\nCPLD升级对象LogicFirmware_xxx的关键属性定义说明：\n\n属性名\nUId\nName\nVersion\nUpgradeChip\nChipInfo\nRoutes\nFirmwareRoute\n\n属性含义\n固件UI的\n固件名\n固件版本号\n升级管理的Chip\nChip信息\n升级路由\n固件路由\n\nCSR对LogicFirmware定义举例（BCU板上的CPLD）：\n\n        \"LogicFirmware_BCU_1\": {\n            \"UId\": \"00000001020302024339\",\n            \"Name\": \"BCU_CPLD1\",\n            \"Manufacturer\": \"Huawei\",\n            \"Version\": \"#/Accessor_LogicVerId.Value\",\n            \"Location\": 6288,\n            \"UpgradeChip\": \"#/Cpld_1\",\n            \"ChipInfo\": \"#/Cpld_1\",\n            \"Routes\": \"#/Accessor_JtagSwitch.Value\",\n            \"DefaultRoute\": 0,\n            \"FirmwareRoute\": 1,\n            \"ValidMode\": 0,\n            \"ValidAction\": 0,\n            \"SoftwareId\": \"CPLD-BC82AMDT\"\n        }\n\n自发现LogicFirmware实现：\n\n      function unit_manager:on_add_object(class_name, object, position)\n          ['LogicFirmware'] = function ()\n             -- 创建对象obj保存LogicFirmware信息：\n              local obj = c_logic_fw.new(object, position, self.bus, device_name)\n             \n              -- 插入obj\n              table.insert(self.logic_fw, obj)\n\n              -- 注册CPLD固件到firmware_mgmt\n              obj:register_logic_fw_info()\n          end)\n       end\n\n1.2、 固件升级、生效信号监听\n\n升级阶段：固件子模块升级包含prepare、process、finish三个阶段，各个阶段需要与固件管理模块进行交互，交互模式均是由固件管理模块发送广播信号，通知固件子模块执行对应的处理；\n升级结果：以上三个阶段都完成后，则认为升级成功，如果中间任意阶段失败则将结束升级流程并返回失败，则认为升级失败，或在规定时间内没有完成各阶段处理，则认为超时失败；\n生效阶段：对于部分固件上电场景下升级后还需要执行生效处理，则会有生效active阶段，且在系统下电时，固件管理发送广播生效信号，通过固件子模块进行生效处理；\n各阶段信号监听及回调：function signal.init(bus, db, fw)\n    -- 监听升级准备信号\n    fw_mgmt_client:SubscribeUpdateServiceUpdateServiceUpgradePrepareSignal(signal.upgrade_prepare_callback)\n    -- 监听升级处理信号\n    fw_mgmt_client:SubscribeUpdateServiceUpdateServiceUpgradeProcessSignal(signal.upgrade_process_callback)\n    -- 监听升级完成信号\n    fw_mgmt_client:SubscribeUpdateServiceUpdateServiceUpgradeFinishSignal(signal.upgrade_finish_callback)\n    -- 监听生效信号\n    fw_mgmt_client:SubscribeFirmwareActiveFirmwareActiveActiveProcessSignal(signal.active_callback)\nend\n\n1.3、 升级各阶段处理\n\n准备阶段：主要是解析升级配置文件、热升级检查、获取当前固件版本号并响应prepare信号；function fw_upgrade.prepare_upgrade(signal, system_id, firmware_type, cfg_path)\n    -- 解析升级配置文件update.cfg\n    signal.upg_cfg_list = cfg:get_cfg_list(cfg_path)\n\n    -- 热升级检查\n    check_hot_upgrade(signal.upg_cfg_list)\n\n    -- 获取当前固件版本号\n    local version = get_prepare_upgrade_version(signal, version)\n\n    -- 响应prepare信号\n    fw_mgmt_client:UpdateServiceUpdateServicePrepareReply(context.new(), system_id, firmware_type, version, ret)\nend\n\n处理阶段：主要是匹配UID找到对应的固件，将升级包选择硬件链路发送过去；function fw_upgrade.process_upgrade(signal, system_id, firmware_type, file_path)\n    if signal.upg_cfg_list[1].update_link and signal.upg_cfg_list[1].update_link == '1' then\n        -- i2c链路升级\n        iic_upgrade:iic_upgrade_cpld(signal.db, signal.fw_list, signal.upg_cfg_list,\n            file_path, system_id, firmware_type)\n    else\n        -- jtag链路升级\n        process_handle:upgrade_component_cpld(signal.db, system_id, signal.fw_list,\n            signal.upg_cfg_list, file_path, g_cpld_upgrade_list, fw_upgrade.hot_upgrade)\n    end\n\n    -- 响应process信号\n    fw_mgmt_client:UpdateServiceUpdateServiceProcessReply(context.new(), system_id, firmware_type,\n        is_need_valid and defs.RET.OK or ret)\nend\n\n完成阶段：区分HOST升级，进行生效文件的处理；function signal.upgrade_finish_callback(ctx, system_id, firmware_type)\n    -- 更新升级进度\n    fw_mgmt_client:UpdateServiceUpdateServiceUpdateUpgradeStatus(context.new(),\n        system_id, firmware_type, ret_ok, 90, 'Running')\n\n    if system_id == defs.ALL_SYSTEM_ID then\n        -- 升级所有HOST\n        upgrade_all_host(system_id, firmware_type, power_state)\n    else\n        -- 升级单HOST\n        upgrade_single_host(system_id, firmware_type, power_state)\n    end\nend\n\n生效阶段：对上电升级缓存的生效文件进行生效处理；function signal.active_callback(ctx, system_id, firmware_type)\n    -- 更新生效状态\n    update_active_status(firmware_id, firmware_type, 'Apply')\n\n    if system_id == defs.ALL_SYSTEM_ID then\n        -- 生效所有HOST\n        active_all_host(system_id, firmware_type)\n    else\n        -- 生效单个HOST\n        active_single_host(system_id, firmware_type)\n    end\nend\n\n2. 板卡管理\n功能描述\n（1）web、redfish、cli接口的板卡信息返回;\n（2）板卡的加载处理；\n（3）板卡相关的告警和传感器；\n\n总结\nlinks: #p-222-general_hardware-1, #p-222-h-2, #p-222-h-3, #p-222-h-4, #p-222-h-1cpld-5, #p-222-h-11-6, #p-222-h-12-7, #p-222-h-13-8, #p-222-h-2-9, #p-222-h-10, #p-222-h-11",
    "topic_user_name": "Changxing Open Ubmc",
    "best_answer_url": "",
    "reply_posts": [
        {
            "user_name": "KunTai_WangJiaKai",
            "topic_closed": null,
            "is_solution": false,
            "post_url": "/t/topic/163/2",
            "text": "请问是否可支持非天池架构标准的背板的cpld升级"
        },
        {
            "user_name": "Changxing Open Ubmc",
            "topic_closed": null,
            "is_solution": false,
            "post_url": "/t/topic/163/3",
            "text": "1、目前升级分带内和带外升级，比如网卡、RAID卡、硬盘等升级都是走的带内，在OS侧通过工具进行升级；\n2、BMC支持的升级都是带外，只能支持满足天池规范标准的器件升级，因为需要读取板卡的UID来区分，才能找到升级的固件位置；\n综上所述：不支持 非天池架构标准 的背板的cpld升级"
        }
    ]
}