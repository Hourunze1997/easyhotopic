{
    "topic_id": 1677,
    "question": "RAID卡配置指南 - content: RAID卡配置指南\n新适配一张RAID卡需要做什么\n新增一个RAID卡的sr文件\nsr文件的主要目的是定义物理器件的链路拓扑，器件，以及对各类对象提供配置信息和属性值，同时还能通过Scanner和Accessor和属性的引用(#/)、同步(<=/)语法来定义属性间的依赖和动态刷新，RAID卡的sr文件是用来告诉openUBMC如何识别、管理RAID的说明书。\n\nRAID的名称、型号和芯片厂商等静态信息\nRAID是否支持带外管理以及TypeId（用于确定带外管理通道类型I2C或者PCIE）\n需要上报的事件和触发条件\n管理RAID卡的传感器\n\n为什么需要这个配置文件？\n\n设备识别：让BMC通过bios上报的四元组加载对应sr文件中配置的RAID卡对象\n状态监控：实时监控RAID卡、BBU的温度等信息\n带外管理：获取和设置RAID卡下的物理盘、逻辑盘等信息\n故障预警：当RAID卡出现问题时及时告警\n维护支持：方便技术人员进行维护和故障排查\n\n如何配置这个文件？\n第一步：了解需要配置的RAID卡\n\n查看RAID卡型号（通常在网卡上会标注）\n获取网卡的基本信息（用于作为sr文件名的四元组：厂商ID，设备ID，子厂商ID，子设备ID，TypeId等）\n热设计\n\n第二步：修改配置文件\n\n基础信息配置\n\n配置正确的文件名称，根据BOM+四元组信息组成对应网卡的文件名\n如下图RAID卡的sr文件名为14140130_19e53758_19e501a4.sr\n\n填写RAID名称和型号\n选择正确的RAID卡TypeId\n具体参考CONTROLLER_TYPE映射表\n\n以上步骤配置完成后网卡可通过csr加载流程加载对应的sr文件，分发sr文件中的Controller对象。\n2. BBU\n\n设置BBU温度\n同步语法设置BBU关联的RAID卡\n\nSASPHY\n\n设置RAID卡的PHY状态，通过例测任务更新\n\n监控配置\n\n设置RAID卡温度传感器，监控阈值，用于告警或调速\n\n其余配置\n\n按需配置告警及其触发条件\n设置LED指示灯代码\n\n带外信息获取\n\n在Controller对象下有一个TypeId属性，该属性用于配合社区组件storage确定带外管理通道类型（I2C或PCIE）和加载对应raid卡厂商的so用于带外管理。\n\n对配置有疑问或者需要支撑的可以在当前话题评论或新增话题我们将尽快回复您\n1. 基础设备对象\n1.1 PCIe设备对象 (PCIeDevice_1)\n{\n    \"PCIeDevice_1\": {\n        \"DeviceName\": \"PCIe Card $ (设备型号)\",\n        \"FunctionClass\": 1,  // 功能类型 （0:未知、1:RAID、2:网卡、3:GPU卡，等）\n        \"Position\": \"\", // 设备位置（容器名称）\n        \"Container\": \"${Container}\", // 载板对象\n        \"GroupPosition\": \"PCIeDevice_${GroupPosition}\", // 板卡组位置\n        \"PCIeDeviceType\": \"SingleFunction\",  // 设备类型\n        \"SlotType\": \"HalfLength\",  // 插槽类型\n        \"FunctionProtocol\": \"PCIe\",  // 协议类型\n        \"FunctionType\": \"Physical\"  // 功能类型\n    }\n}\n\n用途：定义PCIe设备的基本属性和类型，并在PCIe设备加载流程使用。\n必需配置：是\n关键属性：\n\n设备名称\n功能类型\n设备类型\n插槽类型\n\n1.2PCIe卡对象 (PCIeCard_1)\n{\n    \"PCIeCard_1\": {\n        \"Name\": \"设备型号\",\n        \"Description\": \"设备描述\",\n        \"VendorID\": \"厂商ID\",\n        \"DeviceID\": \"设备ID\",\n        \"SubVendorID\": \"子厂商ID\",\n        \"SubDeviceID\": \"子设备ID\",\n        \"Manufacturer\": \"制造商\",\n        \"PartNumber\": \"部件号\",\n        \"RefChip\": \"关联的芯片\",\n        \"Model\": \"型号\",\n        \"FirmwareVersion\": \"固件版本\",\n        \"SerialNumber\": \"序列号\"\n    }\n}\n\n用途：定义PCIe卡的基本信息和属性，部分属性从Controller和PCIeDevice同步而来，用于对外展示PCIe卡的信息\n必需配置：是\n关键属性：\n\n名称\n描述\n厂商ID\n设备ID\n制造商信息\n\n1.3 RAID卡对象(Controller_1)\n{\n    \"Controller_1\": {\n        \"Name\": \"RAID卡名称\",\n        \"TypeId\": \"RAID卡类型Id\",\n        \"OOBSupport\": \"是否支持带外管理\",\n        \"CtrlOption1\": \"RAID控制器支持特性1\",\n        \"CtrlOption2\": \"RAID控制器支持特性2\",\n        \"CtrlOption3\": \"RAID控制器支持特性3\",\n        \"BOMNumber\": \"BOM编码\",\n        \"ChipManufacturer\": \"RAID卡芯片厂商\"\n    }\n}\n\n用途：定义RAID卡的功能属性，是storage组件model.json中定义的Controller类。\n必须配置：是\n关键属性：\nTypeId：存储组件基于TypeId判断raid卡的类型，根据判断出的类型会决定storage组件使用的回调函数库，以及判断RAID卡支持的带外管理通道类型\nOOBSupport：表征RAID卡是否支持带外管理，0表示不支持，1表示支持，支持带外管理的RAID卡存储模块才能正常获取信息\nCtrlOption1：表明RAID卡支持的相关功能，存储组件会基于该属性判断raid卡支持的读策略、写策略、IO策略、访问策略，具体参数含义见storage代码仓common_def.lua中option1_format定义\nCtrlOption2：表明RAID卡支持的相关功能，存储组件会基于该属性判断raid卡支持的硬盘缓存策略、工作模式，具体参数含义见storage代码仓common_def.lua中option2_format定义\nCtrlOption3：表明RAID卡支持的相关功能，存储组件会基于该属性判断raid卡支持的写缓存策略、RAID级别，具体参数含义见storage代码仓common_def.lua中option3_format定义\nBOMNumber：RAID卡硬件资产编号\n\n1.4 电容对象(Battery_1)\n{\n    \"Battery_1\": {\n       \"@Parent\": \"关联的RAID卡对象\",\n       \"RefControllerDeviceName\": \"关联的RAID资源名称\",\n       \"RefControllerSlotId\": \"关联的RAID卡槽位id\",\n       \"RefControllerTypeId\": \"关联的RAID卡TypeId\"\n    },\n}\n\n用途：RAID卡的电容对象，用于BBU在位、温度等信息的获取，以及BBU相关的告警\n必需配置：否，RAID支持bbu时可配置\n\n2 RAID卡功能对象\n2.1 phy误码诊断(SASphy_X)\n{\n        \"SASPhy_1\": {\n            \"@Parent\": \"关联的raid卡对象\",\n            \"PhyId\": 255,\n            \"InvalidDwordCount\": 0,\n            \"LossDwordSyncCount\": 0,\n            \"PhyResetProblemCount\": 0,\n            \"RunningDisparityErrorCount\": 0\n        },\n}\n\n用途：对应RAID卡的Phy误码诊断通道，相关功能在Storage组件的：phy_object.lua文件\n必需配置：是，\n关键属性：\n\n无效DWORD数\n丢失DWORD同步数\nPHY重启问题数\n连续不均衡性错误数\n\n3 监控对象\n传感器定制与开发请参考传感器定制与开发进行配置，以下仅举例RAID卡相关传感器\n3.1门限传感器\n\"ThresholdSensor_RaidCardTemp\": {\n    \"AssertMask\": 128,\n    \"DeassertMask\": 28800,\n    \"ReadingMask\": 2056,\n    \"Linearization\": 0,\n    \"M\": 100,\n    \"RBExp\": 224,\n    \"UpperNoncritical\": 105,\n    \"PositiveHysteresis\": 2,\n    \"NegativeHysteresis\": 2，\n    \"SensorType\": 1,\n    \"ReadingType\": 1,\n    \"SensorName\": \"<=/PCIeDevice_1.SlotID |> string.format('PCIe RAID%s Temp',$1)\",\n    \"Unit\": 128,\n    \"BaseUnit\": 1,\n    \"ModifierUnit\": 0,\n    \"Analog\": 1,\n    \"NominalReading\": 25,\n    \"NormalMaximum\": 0,\n    \"NormalMinimum\": 0,\n    \"MaximumReading\": 127,\n    \"MinimumReading\": 128,\n    \"Reading\": \"<=/Controller_1.TemperatureCelsius\",\n    \"ReadingStatus\": \"<=/Controller_1.TemperatureCelsius |> expr($1 == 32767 ? 1 : ($1 == 255 ? 2 : ($1 == 0 ? 3 : 0)))\"\n},\n\n用途：用于监控连续变化的物理量，监控RAID卡的温度\n适用场景：\n\n温度监控\n\n关键属性：\n\n阈值设置\n滞后值\n读值\n传感器名称\n读值状态\n\n3.2 散热控制对象 (CoolingRequirement_X)\n调速具体使用\n\"CoolingRequirement_1_10\": {\n    \"RequirementId\": \"${Slot} |> expr((10 << 8) | $1)\",\n    \"MonitoringStatus\": \"<=/Controller_1.TemperatureAbnormal\",\n    \"MonitoringValue\": \"<=/Controller_1.TemperatureCelsius |> expr($1 >= 255 ? 30 : $1)\",\n    \"FailedValue\": 80,\n    \"TargetTemperatureCelsius\": 95,\n    \"MaxAllowedTemperatureCelsius\": 103,\n    \"TargetTemperatureRangeCelsius\": [],\n    \"ThresholdValue\": [],\n    \"AlarmSpeed\": [],\n    \"SensorName\": \"#/ThresholdSensor_RaidCardTemp.SensorName\"\n},\n\n用途：定义调速散热参数\n必需配置：是\n关键属性：\n\n读值\n目标温度\n最大允许温度\n温度点失效调速值等\n\n4. 事件对象\n精细化告警开发请参考事件定制进行配置，以下仅举例RAID卡相关告警\n4.1 事件配置说明\n\nEventKeyId：事件唯一标识符\nReading：告警读数，一般配置为对其他值的同步语法，普通的事件比如温度可以直接拿来当做读数，其他类型的比如证书过期，可以是0和1来代替\nCondition：触发条件\n\n数值：直接触发条件\n表达式：基于传感器值或同步其他对象的属性\n\nHysteresis： 迟滞量在恢复告警时使用 ，产生告警时不会使用，如果为0意味着立即恢复 可以理解为误差\nOperatorId： 判断符号，有下列八种判断方式：\n1 ：小于 2 ：小于等于 3 ：大于 4 ：大于等于 5 ：等于 6 ：不等于\n7 ：上升沿0->1产生，1->0恢复 8 ：下降沿1->0产生，0->1恢复\nLedFaultCode：(选配) Led错误码，可为固定值或动态值，x取Component中的Instance填充部分\n\n4.2 RAID卡事件对象\n{\n    \"Event_PCIeRaidComLossMntr\": {\n        \"EventKeyId\": \"PCIeCard.PCIeCardCommunicationLoss\",\n        \"Condition\": 1\n    },\n    \"Event_PCIeRAIDCardFault\": {\n        \"EventKeyId\": \"PCIeRAIDCard.PCIeRAIDCardFault\",\n        \"Condition\": 1,\n        \"LedFaultCode\": \"q$$\"\n    },\n    \"Event_PCIeRaidInitErr\": {\n        \"EventKeyId\": \"PCIeCard.PCIeCardInitializationAbnormal\",\n        \"Condition\": 0\n    },\n}\n\n4.3 温度相关事件\n{\n    \"Event_OverTemp\": {\n        \"EventKeyId\": \"PCIeCard.PCIeCardOverTemp\",\n        \"xxx\": \"xxxx\"\n    },\n    \"Event_TempFail\": {\n        \"EventKeyId\": \"PcieCard.PCIeCardTempFail\",\n        \"xxx\": \"xxxx\"\n    },\n}\n\n4.4 设备状态事件\n{\n    \"Event_BatteryFault\": {\n        \"EventKeyId\": \"PCIeRAIDCard.PCIeCardBBUFault\",\n        \"Condition\": 1,\n        \"LedFaultCode\": \"q$$\"\n    },\n    \"Event_PCIeBandWidth\": {\n        \"EventKeyId\": \"PCIeCard.PCIeCardBandWidthDecreased\",\n        \"Condition\": 1\n    },\n    \"Event_PCIeLinkSpeed\": {\n        \"EventKeyId\": \"PCIeCard.PCIeCardLinkSpeedReduced\",\n        \"Condition\": 1\n    },\n    \"Event_PCIeCardUCE\": {\n        \"EventKeyId\": \"PCIeCard.PCIeCardUncorrectableErr\",\n        \"Condition\": 1,\n        \"LedFaultCode\": \"q$$\"\n    },\n    \"Event_PCIeCardCE\": {\n        \"EventKeyId\": \"PCIeCard.PCIeCardCEHardFailure\",\n        \"Condition\": 1,\n        \"LedFaultCode\": \"q$$\"\n    },\n    \"Event_PcieBBURemove\": {\n        \"EventKeyId\": \"PCIeCard.PCIeCardBBUNotPresent\",\n        \"Condition\": 0\n    },\n    \"Event_PcieBBUInstall\": {\n        \"EventKeyId\": \"PCIeCard.PCIeCardBBUPresent\",\n        \"Condition\": 1\n    },\n}\n\n5. 硬件管理对象\n5.1 FRU对象 (Fru_PCIeCard)\n{\n    \"Fru_PCIeCard\": {\n        \"PcbId\": \"PCB ID\",\n        \"FruId\": 1,\n        \"FruName\": \"FRU名称\",\n        \"ConnectorGroupId\": \"连接器组ID\",\n        \"BoardId\": 255\n    }\n}\n\n用途：定义FRU信息\n必需配置：是\n关键属性：\n\nFRU ID\n名称\nPCB ID\n\n5.2 芯片对象 (Chip_X)\n{\n    \"Chip_RaidChip\": {\n        \"Address\": 122,\n        \"AddrWidth\": 1,\n        \"OffsetWidth\": 0,\n        \"WriteTmout\": 100,\n        \"ReadTmout\": 100,\n        \"HealthStatus\": 0\n    },\n}\n\n5.2 Component对象 (Component_X)\n{\n    \"Component_ComPCIeCard1\": {\n        \"FruId\": 255,\n        \"Instance\": \"<=/PCIeDevice_1.SlotID\",\n        \"Type\": 8,\n        \"Name\": \"<=/PCIeDevice_1.DeviceName\",\n        \"Presence\": 1,\n        \"Health\": 0,\n        \"PowerState\": 1\n    },\n    \"Component_Battery\": {\n        \"FruId\": 255,\n        \"Instance\": \"<=/PCIeDevice_1.SlotID\",\n        \"Type\": 8,\n        \"Name\": \"PCIe Card BBU\",\n        \"Presence\": 1,\n        \"Health\": 0,\n        \"PowerState\": 1\n    },\n    \"Component_PCIeCard\": {\n        \"FruId\": 255,\n        \"Type\": 8,\n        \"Health\": 0,\n        \"PowerState\": 1,\n        \"GroupId\": 1,\n        \"Instance\": 1,\n        \"Name\": \"<=/PCIeDevice_1.DeviceName\",\n        \"Presence\": 1,\n        \"ReplaceFlag\": 0,\n        \"PreviousSN\": \"N/A\",\n        \"SerialNumber\": \"<=/PCIeCard_1.SerialNumber\"\n    },\n}\n\n在soft文件中配置，分别表征RAID卡对象，PCIeDevice对象，BBU对象，关联相关的告警，由fru模块管理，触发告警时会根据告警级别设置关联的RAID卡的健康状态\n6. 管理拓扑对象\n6.1 管理总线对象\n{\n    \"ManagementTopology\": {\n        \"Anchor\": {\n            \"Buses\": [\n                \"I2cMux_Chan\"\n            ]\n        }，\n        \"I2cMux_Chan\": {\n            \"Chips\": [\n                \"Chip_RaidChip\",\n                \"Pca9555_Raid\",\n                \"Eeprom_Raid\",\n                \"Lm75_Raid\"\n            ]\n        }\n    }\n}\n\n用途：定义管理总线拓扑和总线下的Chip对象\n必需配置：是\n关键属性：\n\n总线类型\n通道\n\n7 RAID卡带外注册流程\n加载到CSR，加载了Controller对象会进入流程：\nfunction c_controller:ctor(obj)\nfunction c_controller:init()\n日志打印：\nlog:notice(‘controller init obj.Id = %s, object_id = %s’, self.obj.Id, self.object_id)\n然后会进入Raid卡的注册流程：\nfunction c_controller:register()\n日志打印：\nlog:notice(‘controller%s begin register’, self.Id)\nlog:notice(‘ctrl%s add_controller_to_link_topo successfully’, self.Id)\nlog:notice(‘ctrl%s add_controller_to_sml successfully’, self.Id)\nlog:notice(‘ctrl%s register_controller_to_sml successfully’, self.Id)\n如果以上日志都打印出来了，那么注册流程就算是走完了，也就意味RAID卡注册成功，可以进行带外管理了。少哪一行日志可以去对应位置前看具体可能的错误。\nlinks: #p-4077-raid-1, #p-4077-raid-2, #p-4077-raidsr-3, #p-4077-h-4, #p-4077-h-5, #p-4077-raid-6, #p-4077-h-7, https://gitcode.com/openUBMC/storage/blob/main/src/lualib/controller/controller_object.lua, https://gitcode.com/openUBMC/storage, #p-4077-h-1-8, #p-4077-h-11-pcie-pciedevice_1-9, #p-4077-h-12pcie-pciecard_1-10, #p-4077-h-13-raidcontroller_1-11, #p-4077-h-14-battery_1-12, #p-4077-h-2-raid-13, #p-4077-h-21-physasphy_x-14, #p-4077-h-3-15, https://www.openubmc.cn/docs/zh/development/develop_guide/feature_development/sensor.html, #p-4077-h-31-16, #p-4077-h-32-coolingrequirement_x-17, #p-4077-h-4-18, https://www.openubmc.cn/docs/zh/development/develop_guide/feature_development/event.html, #p-4077-h-41-19, #p-4077-h-42-raid-20, #p-4077-h-43-21, #p-4077-h-44-22, #p-4077-h-5-23, #p-4077-h-51-fru-fru_pciecard-24, #p-4077-h-52-chip_x-25, #p-4077-h-52-component-component_x-26, #p-4077-h-6-27, #p-4077-h-61-28, #p-4077-h-7-raid-29",
    "topic_user_name": "Yelmh Kno07",
    "best_answer_url": "",
    "reply_posts": []
}