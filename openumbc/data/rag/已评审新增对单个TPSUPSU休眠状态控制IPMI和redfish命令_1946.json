{
    "topic_id": 1946,
    "question": "【已评审】新增对单个TPSU/PSU休眠状态控制IPMI和redfish命令 - content: 一、ISSUE链接\n支持对单个TPSU/PSU休眠状态控制\n二、背景\n产品需支持对单个TPSU/PSU休眠模式控制，需提供相应IPMI命令和redfish命令进行设置和查询\n三、决策点\n决策点1：在配置供电信息参数IPMI命令中新增Power Supply Info Parameter参数取值24表示休眠模式\nprivilege：PowerMgmt\nrole：Operator\npriority：Default\n①. 参数说明\n\n字节顺序\n域内容\n\nNetFn\n30h\n\nCMD\n93h\n\n1:3\nManufacturer ID\n\n4\nSub Command，子命令=2Dh\n\n5\nPower Supply Selector, 1 based\n\n6\nPower Supply Info Parameter\n\n7\n[7:1]-reseverd[0]: 级联标志0=是最后一帧数据1=后面还有数据\n\n8\nOffset，写入的数据偏移，从0开始\n\n9\nLength，写入长度\n\n10: N\n写入的数据\n\n即需在字节6：Power Supply Info Parameter中新增参数\n其中Power Supply Info Parameter说明如下\n\nParameter\n\nParameter Data\n#(Decimal Format)\n\nManufacturer\n-\ndata1:N-Get Power Supply ManufacturerMax 50 Bytes. End by null if less than 50 Bytes.\n1\n\nInput Mode\n-\ndata1:1-Get Power Supply Input Mode\n2\n\nModel\n-\ndata1:N-Get Power Supply ModelMax 50 Bytes. End by null if less than 50 Bytes.\n3\n\nVersion\n-\ndata1:N-Get Power Supply VersionMax 50 Bytes. End by null if less than 50 Bytes.\n4\n\nProtocol\n-\ndata1:1-Get Power Supply Protocol\n5\n\nRated Power\n-\ndata1:2 Get Power Supply Rated PowerLS-byte first\n6\n\nVin\nread-only\ndata1:4-Get Power Supply Input Voltage In VoltsLS-byte first\n7\n\n…\n…\n…\n…\n\nDeepSleepEnabled\nread-write\ndata1:1 Set/Get Power Supply Deep Sleep Enabled Status  0x00: 关闭电源深度休眠0x01: 开启电源深度休眠\n24\n\n②. 响应说明：\n\n字节顺序\n域内容\n\n1\nCompletion Code\n\n2:4\nManufacturer ID\n\n③. 示例：\n\n样例\n描述\n命令\n\n1\n设置电源1深度休眠模式开启\nipmitool raw 0x30 0x93 0xdb 0x07 0x00 0x2d 0x01 0x18 0x00 0x00 0x01 0x01\n\n2\n设置不存在的psu_id，返回错误码ParmOutOfRange（0xc9）\nipmitool raw 0x30 0x93 0xdb 0x07 0x00 0x2d *0xff 0x18 0x00 0x00 0x01 0x01\n\n3\n设置时剩余电源不足以支撑整机供电/设置休眠模式失败，返回错误码UnspecifiedError (0xff)\nipmitool raw 0x30 0x93 0xdb 0x07 0x00 0x2d 0x01 0x18 0x00 0x00 0x01 0x01\n\n4\n设置的电源不支持设置深度休眠模式，返回错误码DataNotAvailable (0x80)\nipmitool raw 0x30 0x93 0xdb 0x07 0x00 0x2d 0x01 0x18 0x00 0x00 0x01 0x01\n\n决策点2：在获取电源配置信息IPMI命令中新增Power Supply Info Parameter参数取值24表示休眠模式\nprivilege：ReadOnly\nrole：User\npriority：Default\n①. 参数说明\n\n字节顺序\n域内容\n\nNetFn\n30h\n\nCMD\n93h\n\n1:3\nManufacturer ID\n\n4\nSub Command，子命令=1Eh\n\n5\nPower Supply Selector, 1 based\n\n6\nPower Supply Info Parameter\n\n7\nRead Offset，读取的数据偏移，从0开始\n\n8\nLength，读取长度\n\nPower Supply Info Parameter与设置接口相同\n②. 响应说明：\n\n字节顺序\n域内容\n\n1\nCompletion Code\n\n2:4\nManufacturer ID\n\n5\nEnd of List，0\n\n6:N\nData\n\n③. 示例：\n\n样例\n描述\n命令\n\n1\n正确获取电源1的休眠模式\nipmitool raw 0x30 0x93 0xdb 0x07 0x00 0x1e 0x01 0x18 0x00 0x01\n\n2\n传入不存在的psu_id，返回错误码ParmOutOfRange（0xc9）\nipmitool raw 0x30 0x93 0xdb 0x07 0x00 0x1e 0xff 0x18 0x00 0x01\n\n3\n查询的电源不支持设置深度休眠模式，返回错误码DataNotAvailable (0x80)\nipmitool raw 0x30 0x93 0xdb 0x07 0x00 0x1e 0x01 0x18 0x00 0x01\n\n决策点3：redfish新增设置和查询电源深度休眠模式接口：\nURI: /redfish/v1/Chassis/chassis_id/PowerSubsystem/PowerSupplies/ps_id\n变化类型：新增PATCH/GET方法\n操作类型：PATCH/GET\n\n参数说明：\n\n属性名称\n取值类型\n说明\n取值范围\n默认值\n操作权限\n是否频繁变化并需要屏蔽变化事件\n约束\n\nDeepSleepEnabled\nboolean\n电源休眠模式使能\ntrue：开启深度休眠false：关闭深度休眠null：不支持深度休眠模式\n设置默认值：false显示默认值：null\nPATCH: PowerMgmtGET: ReadOnly\n否\n无\n\nPATCH请求消息体示例：\n{\n    \"Oem\": {\n        \"OemIdentifier\": {\n            \"DeepSleepEnabled\": true\n        }\n    }\n}\n\nPATCH/GET响应示例：\n{\n    \"@odata.context\": \"/redfish/v1/$metadata#PowerSupplies.PowerSupplies\",\n    \"@odata.id\": \"/redfish/v1/Chassis/1/PowerSubsystem/PowerSupplies/1\",\n    \"@odata.type\": \"#PowerSupply.v1_6_0.PowerSupply\",\n    \"Id\": \"1\",\n    \"Name\": \"Power Supply 1\",\n    \"FirmwareVersion\": \"\",\n    \"LineInputStatus\": \"\",\n    \"Manufacturer\": \"XXX\",\n    \"Model\": \"\",\n    \"PartNumber\": \"\",\n    \"PowerSupplyType\": 1,\n    \"ProductionDate\": \"2023-04-19\",\n    \"SerialNumber\": \"\",\n    \"Metrics\": {\n        \"odata.id\": \"/redfish/v1/Chassis/1/PowerSubsystem/PowerSupplies/1/Metrics\"\n    },\n    \"Status\": {\n        \"State\": \"Enabled\",\n        \"Health\": \"OK\"\n    },\n    \"Oem\": {\n        \"OemIdentifier\": {\n            \"DeepSleepEnabled\": true\n        }\n    }\n}\n响应码：200\n\n注：\n设置失败场景包括：\n①. 设置的电源id不存在，则返回PropertyValueOutOfRange；\n②. 根据应用场景，设置时不满足整机供电，则返回OperationFailed；\n③. 不支持设置休眠模式时进行设置，则返回OperationNotSupport；\n四、结论\n决策点：\n\n同意在配置供电信息参数IPMI命令中新增Power Supply Info Parameter参数取值24表示休眠模式\n同意在获取电源配置信息IPMI命令中新增Power Supply Info Parameter参数取值24表示休眠模式\n同意redfish新增设置和查询电源深度休眠模式接口\nuri:  /redfish/v1/Chassis/chassis_id/PowerSubsystem/PowerSupplies/ps_id\n操作类型：PATCH/GET\n变化类型：新增对象Oem/OemIdentifier，以及属性DeepSleepEnabled，该属性表示电源深度休眠模式使能状态，类型为boolean/null，false：关闭深度休眠，true：开启深度休眠，null：不支持深度休眠模式\n应用场景：设置和查询电源深度休眠使能状态\n操作权限：GET：ReadOnly，PATCH：PowerMgmt\n\n遗留问题：\n\n问题：设置电源深度休眠模式接口需要修改为异步操作\n结论：经业务确认，不需要在业务中进行设置失败后重试操作，仅下发设置即可，因此将POST接口修改为PATCH接口，并统一在 /redfish/v1/Chassis/chassis_id/PowerSubsystem/PowerSupplies/ps_id下进行操作；\n问题：后续代码合入时，需同步刷新schema和privilegeMap文件\n结论：已同步刷新详细设计文档，保证schema和privilegeMap文件刷新不遗漏\nlinks: https://gitcode.com/openUBMC/power_mgmt/issues/94",
    "topic_user_name": "Wwhh",
    "best_answer_url": "",
    "reply_posts": [
        {
            "user_name": "huanghan",
            "topic_closed": null,
            "is_solution": false,
            "post_url": "/t/topic/1946/2",
            "text": ""
        }
    ]
}