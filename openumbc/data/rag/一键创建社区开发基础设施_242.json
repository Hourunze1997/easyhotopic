{
    "topic_id": 242,
    "question": "一键创建社区开发基础设施 - content: 说明\n本文档指导开发构建使用docker以及编排工具docker-compose一键创建社区开发所需要的基础设施，包括：\n\njfrog cpp ce制品仓（conan包管理器和服务）\njenkins流水线（用于openubmc构建流水线）\nnexus制品仓(用于apt、pip、npm源管理)\n\n本文档仅是示例，相关工具&软件的文档、授权以及后续的变更都以软件官方为准。\n本文不包含流水线实现、制品仓配置，后续补充。\n\n环境准备\ndocker安装\nInstall Docker Engine on Ubuntu\n# apt安装docker\nsudo apt-get update\nsudo apt-get install ca-certificates curl\nsudo install -m 0755 -d /etc/apt/keyrings\nsudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc\nsudo chmod a+r /etc/apt/keyrings/docker.asc\n\n# Add the repository to Apt sources:\necho \\\n  \"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \\\n  $(. /etc/os-release && echo \"${UBUNTU_CODENAME:-$VERSION_CODENAME}\") stable\" | \\\n  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null\nsudo apt-get update\n\ndocker-compose安装\ndocker-compose 是一个容器编排工具，官方文档 安装指导\n# 快速安装命令\ncurl -SL https://github.com/docker/compose/releases/download/v2.33.1/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose\nchmod +x /usr/local/bin/docker-compose\n\n容器编排\ndocker-compose.yml用以编排容器，将文件放置在/home/podman目录。\nmkdir /home/podman -p\ncd /home/podman\ncat << EOF > ./docker-compose.yml\n# yaml 配置实例\nversion: '3'\nservices:\n  nginx:\n    image: \"swr.cn-north-4.myhuaweicloud.com/openubmc-test/nginx:alpine\"\n    restart: always\n    ports:\n      - \"1080:80\"\n      - \"1443:443\"\n    volumes:\n      - /home/podman/nginx/ssl:/etc/nginx/ssl\n      - /home/podman/nginx/conf.d:/etc/nginx/conf.d\n      - /home/podman/nginx/www:/usr/share/nginx/html\n    links:\n      - jenkins\n      - jfrog_conan\n      - nexus_oss\n  jenkins:\n    image: swr.cn-north-4.myhuaweicloud.com/openubmc-test/jenkins:2.444\n    restart: always\n    volumes:\n      - /home/podman/jenkins/:/var/jenkins_home\n  nexus_oss:\n    image: swr.cn-north-4.myhuaweicloud.com/openubmc-test/sonatype/nexus3:3.78.0\n    restart: always\n    volumes:\n      - /home/podman/nexus_data:/nexus-data\n  jfrog_conan:\n    image: swr.cn-north-4.myhuaweicloud.com/openubmc-test/artifactory-cpp-ce:7.63.12\n    restart: always\n    volumes:\n      - /home/podman/artifactory-cpp-ce:/var/opt/jfrog/artifactory\nEOF\n\n创建必要的目录\n上述编排脚本需要映射几个目录，需要手工创建。\n# 创建jenkins目录\nmkdir /home/podman -p\ncd /home/podman\nmkdir jenkins\nchown 1000:1000 jenkins\nmkdir nexus_data\nchown 200:200 nexus_data\nmkdir artifactory-cpp-ce\nchown 1030:1030 artifactory-cpp-ce\n\n配置nginx访问jenkins\nmkdir /home/podman -p\ncd /home/podman\nmkdir nginx/conf.d -p\n# 创建nginx配置文件，注意将 jenkins.example.com 替换成真实域名\ncat << EOF > nginx/conf.d/jenkins.conf\nserver {\n    listen       80;\n    listen  [::]:80;\n    server_name  jenkins.example.com;\n    error_log /var/log/error.log warn;\n\n    location / {\n        client_max_body_size 200M;\n        proxy_set_header    X-Forwarded-Port  $http_port;\n        proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;\n        proxy_set_header    Host              $http_host;\n        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;\n        proxy_pass http://jenkins:8080/;\n    }\n}\nEOF\n\n配置nginx访问nexus\nmkdir /home/podman -p\ncd /home/podman\nmkdir nginx/conf.d -p\n# 创建nginx配置文件，注意将 nexus.example.com 替换成真实域名\ncat << EOF > nginx/conf.d/nexus.conf\nserver {\n    listen       80;\n    listen  [::]:80;\n    server_name  nexus.example.com;\n    error_log /var/log/error.log warn;\n\n    location / {\n        client_max_body_size 200M;\n        proxy_set_header    X-Forwarded-Port  $http_port;\n        proxy_set_header    X-Forwarded-Proto $scheme;\n        proxy_set_header    Host              $http_host;\n        proxy_pass http://nexus_oss:8081/;\n    }\n}\nEOF\n\n配置nginx访问conan\nmkdir /home/podman -p\ncd /home/podman\nmkdir nginx/conf.d -p\n# 创建nginx配置文件，注意将 conan.example.com 和 conanui.example.com  替换成真实域名\ncat << EOF > nginx/conf.d/conan.conf\nserver {\n    listen       80;\n    listen  [::]:80;\n    server_name  conan.example.com;\n    error_log /var/log/error.log warn;\n\n    location / {\n        client_max_body_size 200M;\n        proxy_set_header    X-JFrog-Override-Base-Url $https://$host;\n        proxy_set_header    X-Forwarded-Port  $http_port;\n        proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;\n        proxy_set_header    Host              $http_host;\n        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;\n        proxy_pass http://jfrog_conan:8081/;\n    }\n}\n\nserver {\n    listen       80;\n    listen  [::]:80;\n    server_name  conanui.example.com;\n    error_log /var/log/error.log warn;\n\n    location / {\n        client_max_body_size 200M;\n        proxy_set_header    X-JFrog-Override-Base-Url $https://$host;\n        proxy_set_header    X-Forwarded-Port  $http_port;\n        proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;\n        proxy_set_header    Host              $http_host;\n        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;\n        proxy_pass http://jfrog_conan:8082/;\n    }\n}\nEOF\n\n配置域名\nnginx配置了多个域名，需要开发者做好域名解析，如果无法修改域名或者没有域名，可以修改hosts文件提供本地化解析。\n\nwindows请参考 windows修改host\nlinux请修改/etc/hosts\n\n启动容器\ncd /home/podman\n# 后台运行\ndocker-compose up -d\n# 或者前台运行\ndocker-compose up\nlinks: #p-351-h-1, #p-351-h-2, #p-351-docker-3, https://docs.docker.com/engine/install/ubuntu/, #p-351-docker-compose-4, https://docs.docker.com/compose/, https://docs.docker.com/compose/install/linux/#install-the-plugin-manually, #p-351-h-5, #p-351-h-6, #p-351-nginxjenkins-7, #p-351-nginxnexus-8, #p-351-nginxconan-9, #p-351-h-10, https://answers.microsoft.com/zh-hans/windows/forum/all/win10%E4%B8%93%E4%B8%9A%E7%89%88%E4%BF%AE%E6%94%B9/f04ce283-2173-41da-bd4b-0d6acb0440a8, #p-351-h-11",
    "topic_user_name": "xuhaijun",
    "best_answer_url": "",
    "reply_posts": []
}