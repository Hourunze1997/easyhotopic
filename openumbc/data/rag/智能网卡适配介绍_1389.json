{
    "topic_id": 1389,
    "question": "智能网卡适配介绍 - content: 简介\n本文以DPU卡和BF卡举例，介绍智能网卡的加载适配流程\n智能网卡介绍\n智能网卡（SmartNIC）是一种高级网络接口卡，其具有传统NIC的功能，并在此基础上集成了额外的处理能力，使之能够支持执行更加复杂的网络任务，从而减轻主机CPU的负担，提高网络效率和性能。\n智能网卡分类\n智能网卡分为两类SDI（Service Drive Infrastructure）卡和DPU （Data Processing Unit）卡：\n\nSDI卡目前有：SDI V3 Lite、SDI V3、SDI V3.5、SDI 5.0、SDI 5.1、SDI5.0.C、SDI5.0 Lite、SDI6.0\nDPU卡目前有：SP923D、SP923Q、SP923H、SP925D\n本文介绍常见的BlueFiled - 2和BlueFiled - 3也属于DPU卡\n\n1.BF卡加载适配\n1.1 识别方式\n通过e2p加载\n1.2 代码适配\n代码仓\nvpd\n在vendor/Mellanox/路径下创建对应的csr路径，路径下创建csr文件，csr文件以四元组信息命\n\ncsr配置\n\n配置PCIeDevice对象：定义PCIe设备的基本属性和类型\n关键属性：\n\nDeviceName：设备名称\nFunctionClass：功能类型\nDeviceType：设备类型\nSlotType：槽位类型\nFunctionProtocol：协议类型\n\n        \"PCIeDevice_1\": {\n            \"DeviceName\": \"PCIe Card $ (MT42822 BlueField-2)\",\n            \"FunctionClass\": 2,\n            \"Position\": \"\",\n            \"DiagnosticFault\": 0,\n            \"PredictiveFault\": 0,\n            \"LinkSpeedReduced\": 0,\n            \"DeviceType\": 8,\n            \"CorrectableError\": 0,\n            \"UncorrectableError\": 0,\n            \"FatalError\": 0,\n            \"GroupPosition\": \"PCIeDevice_${GroupPosition}\",\n            \"Container\": \"${Container}\",\n            \"SlotType\": \"FullLength\",\n            \"FunctionProtocol\": \"PCIe\",\n            \"FunctionType\": \"Physical\",\n            \"PCIeDeviceType\": \"MultiFunction\"\n        },\n\n配置PCIeCard对象：定义PCIe卡的基本信息和属性\n关键属性：\n\nName：名称\nDescription：描述\nVendorID：厂商ID\nDeviceID：设备ID\nSubVendorID：子厂商ID\nSubDeviceID：子设备ID\nModel：型号\n\n        \"PCIeCard_1\": {\n            \"SlotID\": \"<=/PCIeDevice_1.SlotID\",\n            \"NodeID\": \"<=/PCIeDevice_1.SlotID |> string.format('PCIeCard%s',$1)\",\n            \"Name\": \"MBF2H332A-AENOT\",\n            \"BoardName\": \"MT42822 BlueField-2\",\n            \"Description\": \"MT42822 BlueField-2 integrated ConnectX-7 network controller\",\n            \"FunctionClass\": 2,\n            \"VendorID\": 5555,\n            \"DeviceID\": 41686,\n            \"SubVendorID\": 5555,\n            \"SubDeviceID\": 96,\n            \"PartNumber\": \"MBF2H332A-AENOT\",\n            \"Position\": \"<=/PCIeDevice_1.Position\",\n            \"LaneOwner\": \"<=/PCIeDevice_1.SocketID\",\n            \"FirmwareVersion\": \"<=/NetworkAdapter_1.FirmwareVersion\",\n            \"Manufacturer\": \"Mellanox\",\n            \"Health\": \"<=/Component_PCIeCard.Health\",\n            \"Model\": \"BF2\",\n            \"DeviceName\": \"<=/PCIeDevice_1.DeviceName\",\n            \"PcbVersion\": \"\",\n            \"Bus\": \"<=/PCIeDevice_1.Bus\",\n            \"Device\": \"<=/PCIeDevice_1.Device\",\n            \"Function\": \"<=/PCIeDevice_1.Function\",\n            \"DevBus\": \"<=/PCIeDevice_1.DevBus\",\n            \"DevDevice\": \"<=/PCIeDevice_1.DevDevice\",\n            \"DevFunction\": \"<=/PCIeDevice_1.DevFunction\",\n            \"SerialNumber\": \"<=/FruData_BF2.BoardSerialNumber |> expr(string.gsub($1, '%s+$','') )\"\n        },\n\n配置NetworkAdapter对象：定义网络适配器的功能和特性\n关键属性：\n\nName：名称\nDescription：描述\nManufacturer：厂商\nNetworkPortCount：端口数量\nLinkSpeedCapability：链路支持速率\nLinkWidthCapability：链路支持带宽\n\n        \"NetworkAdapter_1\": {\n            \"SystemID\": 1,\n            \"SlotNumber\": \"<=/PCIeDevice_1.SlotID\",\n            \"Name\": \"MBF2H332A-AENOT\",\n            \"Manufacturer\": \"Mellanox\",\n            \"Description\": \"2*25GE\",\n            \"Position\": \"<=/PCIeDevice_1.Position\",\n            \"DeviceLocator\": \"<=/PCIeDevice_1.DeviceName\",\n            \"Type\": 3,\n            \"Model\": \"BF2\",\n            \"ModelDescription\": \"2*25GE\",\n            \"ChipVendor\": \"Mellanox\",\n            \"ChipManufacturer\": \"<=/PCIeCard_1.Manufacturer\",\n            \"NetworkPortCount\": 2,\n            \"BoardName\": \"MT42822 BlueField-2\",\n            \"VendorID\": \"0x15b3\",\n            \"DeviceID\": \"0xa2d6\",\n            \"SubsystemVendorID\": \"0x15b3\",\n            \"SubsystemDeviceID\": \"0x0060\",\n            \"ComponentUniqueID\": \"\",\n            \"PCBVersion\": \"<=/PCIeCard_1.PcbVersion\",\n            \"FruId\": 255,\n            \"SupportedMctp\": true,  // 是否支持MCTP\n            \"HotPluggable\": false, // 是否支持热拔插\n            \"ReadyToRemove\": false,\n            \"AttentionHotPlugState\": 255,\n            \"SocketId\": \"<=/PCIeDevice_1.SocketID\",\n            \"Bus\": \"<=/PCIeDevice_1.Bus\",\n            \"Device\": \"<=/PCIeDevice_1.Device\",\n            \"Function\": \"<=/PCIeDevice_1.Function\",\n            \"DevBus\": \"<=/PCIeDevice_1.DevBus\",\n            \"DevDevice\": \"<=/PCIeDevice_1.DevDevice\",\n            \"DevFunction\": \"<=/PCIeDevice_1.DevFunction\",\n            \"LinkSpeed\": \"\",\n            \"LinkSpeedCapability\": \"Gen5 (32.0GT/s)\",\n            \"LinkWidth\": \"\",\n            \"LinkWidthCapability\": \"X8\",\n            \"TemperatureCelsius\": 0,\n            \"TemperatureStatus\": 0,\n            \"BandwidthThresholdPercent\": 100,\n            \"ParentCardSlotId\": 255,\n            \"Health\": \"<=/Component_PCIeCard.Health\",\n            \"SerialNumber\": \"<=/PCIeCard_1.SerialNumber\"\n        },\n\n配置NetworkPort对象：定义网口对象属性和能力\n关键属性：\n\nPortID：端口ID\nNetDevFuncType：设备功能类型\nMediumType：介质类型\nSupportedLinkCapability：链路能力\n\n        \"NetworkPort_1\": {\n            \"@Parent\": \"NetworkAdapter_1\",\n            \"SystemID\": 1,\n            \"PortID\": 0,\n            \"NetDevFuncType\": 1,\n            \"MediumType\": \"FiberOptic\",\n            \"SupportedLinkCapability\": \"25GE\"\n        },\n\n配置OpticalModule对象：定义光模块对象的属性\n关键属性：\n\nChannelNum：端口ID\nTemp_UpperThresholdCritical：温度上限阈值\nLowerThresholdCritical：下限阈值\nUpperThresholdCritical：上限阈值\n\n        \"OpticalModule_1\": {\n            \"@Parent\": \"NetworkPort_1\",\n            \"ChannelNum\": 1,\n            \"TemperatureCelsius\": 0,\n            \"PowerState\": 0,\n            \"Presence\": 1,\n            \"IsSupportedType\": 0,\n            \"Temp_UpperThresholdCritical\": 125,\n            \"FaultState\": 0,\n            \"SupplyVoltage\": 0,\n            \"LowerThresholdCritical\": 0,\n            \"UpperThresholdCritical\": 0\n        },\n\n配置Scanner_NICTemp对象：定义网卡温度扫描对象信息\n\n        \"Chip_TempChip\": {\n            \"Address\": 62,\n            \"AddrWidth\": 1,\n            \"OffsetWidth\": 1,\n            \"WriteTmout\": 100,\n            \"ReadTmout\": 100,\n            \"HealthStatus\": 0\n        },\n        \"Scanner_NICTemp\": {\n            \"Chip\": \"#/Chip_TempChip\",\n            \"Size\": 1,\n            \"Offset\": 1,\n            \"Mask\": 65535,\n            \"Period\": 1000,\n            \"Type\": 0,\n            \"Debounce\": \"#/MidAvg_NICTemp\"\n        },\n\n配置ThresholdSensor_XXXX对象：定义阈值传感器信息\n关键属性：\n\nAssertMask：断言掩码\nDeassertMask：取消断言掩码\nUpperNoncritical：上限非临界值\nPositiveHysteresis：正向迟滞量\nNegativeHysteresis：负向迟滞量\n\n        \"ThresholdSensor_Temp\": {\n            \"AssertMask\": 128,\n            \"DeassertMask\": 28800,\n            \"ReadingMask\": 2056,\n            \"Linearization\": 0,\n            \"M\": 100,\n            \"RBExp\": 224,\n            \"UpperNoncritical\": 104,\n            \"PositiveHysteresis\": 2,\n            \"NegativeHysteresis\": 2\n        },\n        \"ThresholdSensor_OpticalModuleTemp\": {\n            \"AssertMask\": 128,\n            \"DeassertMask\": 28800,\n            \"ReadingMask\": 2056,\n            \"Linearization\": 0,\n            \"M\": 1,\n            \"UpperNoncritical\": 70,\n            \"PositiveHysteresis\": 2,\n            \"NegativeHysteresis\": 2\n        },\n\n配置CoolingRequirement_X：定义散热需求的控制参数\n关键属性：\n\nRequirementId：需求ID\nMonitoringStatus：监控状态\nMonitoringValue：监控值\nFailedValue：失效调速值\nTargetTemperatureCelsius：目标温度\nMaxAllowedTemperatureCelsius：触发全速温度\nSmartCoolingTargetTemperature：智能调速目标温度\n\n        \"CoolingRequirement_1_88\": {\n            \"RequirementId\": \"${Slot} |> expr((88 << 8) | $1)\", // ID与上一行ID一致\n            \"Description\": \"BF2网卡芯片调速\",\n            \"MonitoringStatus\": \"<=/Scanner_NICTemp.Status\",\n            \"MonitoringValue\": \"<=/Scanner_NICTemp.Value\",\n            \"FailedValue\": 80,\n            \"TargetTemperatureCelsius\": 90,\n            \"MaxAllowedTemperatureCelsius\": 100,\n            \"TargetTemperatureRangeCelsius\": [],\n            \"SmartCoolingTargetTemperature\": [],\n            \"CustomSupported\": false,\n            \"ActiveInStandby\": true,\n            \"CustomTargetTemperatureCelsius\": 255,\n            \"Enabled\": \"<=/CoolingRequirement_1_96.MonitoringStatus |> expr($1 == 0 ? true : false)\",\n            \"SensorName\": \"#/ThresholdSensor_Temp.SensorName\"\n        },\n\n配置调速策略还要在产品仓的psr中配置CoolingArea，其AreaId与CoolingRequirement的RequirementId一致：\n关键属性：\n+ AreaId：调速策略ID\n+ FanIdxGroup：风扇序号列表\n    \"CoolingArea_1_88\": {\n      \"AreaId\": 88, // ID与上一行ID一致，与RequirementId一致\n      \"RequirementIdx\": 88, // ID与上一行ID一致\n      \"PolicyIdxGroup\": [],\n      \"FanIdxGroup\": [\n        1,\n        2,\n        3,\n        4\n      ]\n    },\n\n配置Event_XXXX告警和事件：定义告警和事件的上报规则\n\ncsr配置\n关键属性：\n\nEventKeyId：事件标识ID\nCondition：告警门限值\nHysteresis：迟滞量\n\n        \"Event_OverTemp\": {\n            \"EventKeyId\": \"PCIeCard.PCIeCardOverTemp\",\n            \"Condition\": \"<=/ThresholdSensor_Temp.UpperNoncritical\",\n            \"Hysteresis\": \"<=/ThresholdSensor_Temp.PositiveHysteresis\"\n        },\n\nsoft csr配置\n关键属性：\n\nReading：告警读数\nCondition：告警门限值\nOperatorId：判断符号:1：小于 2：小于等于 3：大于 4：大于等于 5：等于 6：不等于 7：上升沿0->1产生，1->0恢复 8：下降沿1->0产生，0->1恢复\nAdditionalInfo：第X个动态参数\nDescArgx：动态参数\n\n        \"Event_OverTemp\": {\n            \"Reading\": \"<=/Scanner_NICTemp.Value |> expr(($1 >= 128) ? ($1 - 256) : $1)\",\n            \"@Default\": {\n                \"Condition\": 105\n            },\n            \"OperatorId\": 4,\n            \"Enabled\": true,\n            \"Component\": \"#/Component_PCIeCard\",\n            \"AdditionalInfo\": \"1\",\n            \"DescArg2\": \"#/Component_PCIeCard.Name\",\n            \"DescArg4\": \"#/Event_OverTemp.Reading\",\n            \"DescArg5\": \"#/ThresholdSensor_Temp.UpperNoncritical\"\n        },\n\nEventKeyId配置在vpd仓vendor/event_def.json中\n关键属性：\n+ EventCode：事件码\n+ EventType：事件类型\n+ LifeCycleId：事件生命周期\n+ DeassertFlag：是否可以恢复\n+ EventKeyId：事件标识ID\n        {\n            \"EventCode\": \"0x08000003\",\n            \"ReportChannel\": 65535,\n            \"OldEventCode\": \"0x0147FFFF\",\n            \"EventType\": 0,\n            \"LifeCycleId\": 1,\n            \"DeassertFlag\": 1,\n            \"EventKeyId\": \"PCIeCard.PCIeCardOverTemp\",\n            \"SeverityId\": 1,\n            \"ActionId\": 0,\n            \"EventName\": \"PCIeCardOverTemp\"\n        },\n        ...\n        {\n            \"Suggestion\": {\n                \"En\": \"1. Check for fan alarms.@#AB;2. Check the equipment room temperature.@#AB;3. Check for air inlet or outlet blockage.@#AB;4. Replace the PCIe card.\",\n                \"Zh\": \"1. 检查服务器是否存在风扇告警。@#AB;2. 检查机房环境温度是否已超出服务器设备运行环境要求。@#AB;3. 检查服务器进风口/出风口是否有异物堵塞。@#AB;4. 更换PCIe标卡。\"\n            },\n            \"EventKeyId\": \"PCIeCard.PCIeCardOverTemp\",\n            \"Description\": {\n                \"En\": \"The %1 %2 %3 temperature (%4 degrees C) exceeds the overtemperature threshold (%5 degrees C).\",\n                \"Zh\": \"The %1 %2 %3 temperature (%4 degrees C) exceeds the overtemperature threshold (%5 degrees C).\"\n            },\n            \"Influence\": {\n                \"En\": \"\",\n                \"Zh\": \"\"\n            },\n            \"Cause\": {\n                \"En\": \"\",\n                \"Zh\": \"\"\n            }\n        },\n\ncsr加载\n在产品仓对应的产品的profile.txt下，配置新增的csr文件，将csr打包到对应的版本，路径信息参考其他产品配置\n1.3 ncsi协议介绍\nBF系列卡当前以网卡的方式加载，卡侧信息需要通过ncsi协议读取\n代码仓\nnetwork_adapter\n在src/lualib/hardware_config路径下创建对应BF卡的lua文件，文件名与BF卡的NetworkAdapter对象中的Model属性一致，配置需注意\n\n命令配置\n    properties = {\n        GetOSStatus = {\n            protocol = 'ncsi_mellanox',\n            action = 'on_schedule',\n            period_in_sec = 2,\n            request = {\n                channel_id = 0x1F,\n                cmd_mellanox = 0x00,\n                mellanox_cmd_id = 0x13,\n                parameter = 0x17,\n                extra_cmd = 0x00\n            },\n            response = function(data)\n                local r = bs.new([[<<\n                    _:32,\n                    os_status:8\n                >>]]):unpack(data, true)\n                return r.os_status\n            end\n        }\n    }\n\n字段介绍\n\nproperties：properties中配置接口/方法配置信息，接口包含protocol、action、request、response等信息；\nprotocol：协议，当前支持ncsi_standard、ncsi_mellanox、ncsi_huawei协议，针对不同厂商的板卡选取对应的协议；\naction：行为，包含on_demand和on_schedule两种类型，on_demand表示仅读取一次，on_schedule表示每隔多久读取一次；\nperiod_in_sec：仅在action为on_schedule时需要配置且生效，表示循环读取是间隔的时长；\nrequest：请求，其中包含channel_id、package_id、cmd、parameter等信息，根据厂商提供的指导进行配置；\nresponse：响应，返回一个二进制，需要进行unpack，参考厂商提供的指导对二进制进行解析，获取返回；\n\n2.DPU卡加载适配\n2.1 识别方式\n通过四元组加载\n2.2 代码适配\nDPU卡csr配置在私仓，需要开发者进行适配后打包到版本包中，以四元组对csr进行命名，BMC升级后，csr在/opt/bmc/sr路径下\ncsr配置\n\n配置PCIeDevice对象：定义PCIe设备的基本属性和类型\n关键属性：\n\nDeviceName：设备名称\nFunctionClass：功能类型\nDeviceType：设备类型\nSlotType：槽位类型\nFunctionProtocol：协议类型\n\n        \"PCIeDevice_1\": {\n            \"DeviceName\": \"PCIe Card $ (XXXX)\",\n            \"DeviceType\": 8,\n            \"FunctionClass\": 11,\n            \"DiagnosticFault\": 0,\n            \"PredictiveFault\": 0,\n            \"LinkSpeedReduced\": 0,\n            \"Container\": \"${Container}\",\n            \"GroupPosition\": \"PCIeDevice_${GroupPosition}\",\n            \"PCIeDeviceType\": \"MultiFunction\",\n            \"SlotType\": \"FullLength\",\n            \"FunctionProtocol\": \"PCIe\",\n            \"FunctionType\": \"Physical\"\n        },\n\n配置DPUCard对象：定义DPU卡对象的属性\n关键属性：\n\nModel：型号\nPCIeModel：PCIe型号\nName：名称\nPartNumber：部件编号\nNICBoardName：NIC板名称\n\n        \"DPUCard_1\": {\n            \"Model\": \"AAAA\",\n            \"PCIeModel\": \"BBBB\",\n            \"Name\": \"XXXX\",\n            \"BoardID\": 239,\n            \"BoardName\": \"AAAA\",\n            \"PartNumber\": \"CCCC\",\n            \"Description\": \"XXXX\",\n            \"M2SlotMaxCount\": 2,\n            \"NetworkAdapterMaxCount\": 2,\n            \"StorageIpAddr\": \"0.0.0.0\",\n            \"FunctionClass\": 11,\n            \"CPLDCount\": 2,\n            \"CPUBoardName\": \"AAAA\",\n            \"NICBoardName\": \"DDDD\",\n            \"SlotID\": \"<=/PCIeDevice_1.SlotID\",\n            \"NodeID\": \"<=/PCIeDevice_1.SlotID |> string.format('PCIeCard%s',$1)\",\n            \"Manufacturer\": \"Huawei\",\n            \"PcbVersion\": \"<=/Fru_DPUCard.PcbVersion\",\n            \"RefChip\": \"#/Chip_MCU\",\n            \"RefIdChip\": \"#/Chip_PcbId\",\n            \"Health\": \"<=/Component_DPUCard.Health;<=/Component_PCIeCard.Health;<=/Component_Cable.Health |> expr(($1 > 0 || $2 > 0 || $3 > 0) ? (($1 >= $2 && $1 >= $3) ? $1 : (($2 >= $1 && $2 >= $3) ? $2 : $3)) : 0)\",\n            \"HeartBeatLoss\": 0,\n            \"SystemLoadedStatus\": 0,\n            \"PowerState\": \"Off\",\n            \"SerialRecordConnect\": [\n                {\n                    \"Source\": \"UART4 COM\",\n                    \"Destination\": \"CARD COM\",\n                    \"SrcSerial\": 4,\n                    \"DestSerial\": 21\n                }\n            ],\n            \"RefFrudata\": \"#/FruData_DPUCard\",\n            \"RefNetCard\": \"#/NetworkAdapter_1\",\n            \"LinkWidthCapability\": \"<=/NetworkAdapter_1.LinkWidthCapability\",\n            \"LinkSpeedCapability\": \"<=/NetworkAdapter_1.LinkSpeedCapability\",\n            \"LinkWidth\": \"<=/NetworkAdapter_1.LinkWidth\",\n            \"LinkSpeed\": \"<=/NetworkAdapter_1.LinkSpeed\",\n            \"VendorID\": \"#/NetworkAdapter_1.VendorID\",\n            \"DeviceID\": \"#/NetworkAdapter_1.DeviceID\",\n            \"SubVendorID\": \"#/NetworkAdapter_1.SubsystemVendorID\",\n            \"SubDeviceID\": \"#/NetworkAdapter_1.SubsystemDeviceID\",\n            \"Position\": \"<=/PCIeDevice_1.Position\",\n            \"LaneOwner\": \"<=/PCIeDevice_1.SocketID\",\n            \"DeviceName\": \"<=/PCIeDevice_1.DeviceName\",\n            \"SRVersion\": \"${DataVersion}\",\n            \"UID\": \"0123456789ABCDEFGH\",\n            \"SerialNumber\": \"<=/FruData_DPUCard.BoardSerialNumber\",\n            \"FirmwareVersion\": \"<=/NetworkAdapter_1.FirmwareVersion\"\n        },\n\n配置NetworkAdapter对象：定义网络适配器的功能和特性\n关键属性：\n\nName：名称\nDescription：描述\nManufacturer：厂商\nNetworkPortCount：端口数量\nLinkSpeedCapability：链路支持速率\nLinkWidthCapability：链路支持带宽\n\n            \"SystemID\": 1,\n            \"SlotNumber\": \"<=/PCIeDevice_1.SlotID\",\n            \"NodeID\": \"<=/PCIeDevice_1.SlotID |> string.format('PCIeCard%s',$1)\",\n            \"Name\": \"XXXX\",\n            \"Manufacturer\": \"Huawei\",\n            \"Description\": \"6*25GE\",\n            \"Position\": \"<=/PCIeDevice_1.Position\",\n            \"DeviceLocator\": \"<=/PCIeDevice_1.DeviceName\",\n            \"Type\": 3,\n            \"Model\": \"AAAA\",\n            \"ModelDescription\": \"6*25GE\",\n            \"ChipVendor\": \"Huawei\",\n            \"ChipManufacturer\": \"Huawei\",\n            \"NetworkPortCount\": 6,\n            \"BoardID\": 239,\n            \"VendorID\": \"0x19e5\",\n            \"DeviceID\": \"0x0224\",\n            \"SubsystemVendorID\": \"0x19e5\",\n            \"SubsystemDeviceID\": \"0x0356\",\n            \"ComponentUniqueID\": \"0123456789ABCDEFGH\",\n            \"PCBVersion\": \"<=/DPUCard_1.PcbVersion\",\n            \"@Default\": {\n                \"PCBVersion\": \".A\"\n            },\n            \"FruId\": \"<=/FruData_DPUCard.FruId\",\n            \"SupportedMctp\": true,\n            \"SupportedLLDP\": true,\n            \"HotPluggable\": false,\n            \"ReadyToRemove\": false,\n            \"AttentionHotPlugState\": 255,\n            \"SocketId\": \"<=/PCIeDevice_1.SocketID\",\n            \"Bus\": \"<=/PCIeDevice_1.Bus\",\n            \"Device\": \"<=/PCIeDevice_1.Device\",\n            \"Function\": \"<=/PCIeDevice_1.Function\",\n            \"DevBus\": \"<=/PCIeDevice_1.DevBus\",\n            \"DevDevice\": \"<=/PCIeDevice_1.DevDevice\",\n            \"DevFunction\": \"<=/PCIeDevice_1.DevFunction\",\n            \"SpecialPcieCard\": true,\n            \"LinkWidthCapability\": \"N/A\",\n            \"LinkSpeedCapability\": \"N/A\",\n            \"LinkWidth\": \"N/A\",\n            \"LinkSpeed\": \"N/A\",\n            \"TemperatureCelsius\": 0,\n            \"TemperatureStatus\": 0,\n            \"ParentCardSlotId\": \"<=/PCIeDevice_1.SlotID\",\n            \"FaultState\": 0,\n            \"Health\": \"<=/Component_DPUCard.Health;<=/Component_PCIeCard.Health;<=/Component_Cable.Health |> expr(($1 > 0 || $2 > 0 || $3 > 0) ? (($1 >= $2 && $1 >= $3) ? $1 : (($2 >= $1 && $2 >= $3) ? $2 : $3)) : 0)\",\n            \"PfMacInfo\":\"<=/DPUCard_1.PfMacInfo\"\n        },\n\n配置NetworkPort_X对象定义网口对象属性和能力\n关键属性：\n\nPortID：端口ID\nNetDevFuncType：设备功能类型\nMediumType：介质类型\nSupportedLinkCapability：链路能力\n\n        \"NetworkPort_1\": {\n            \"@Parent\": \"NetworkAdapter_1\",\n            \"SystemID\": 1,\n            \"PortID\": 0,\n            \"NetDevFuncType\": 1,\n            \"MediumType\": \"FiberOptic\",\n            \"SupportedLinkCapability\": \"25GE\",\n            \"WorkloadType\" : 0\n        },\n\n配置OpticalModule_X对象：定义光模块对象的属性\n关键属性：\n\nChannelNum：端口ID\n\n        \"OpticalModule_1\": {\n            \"@Parent\": \"NetworkPort_1\",\n            \"ChannelNum\": 1\n        },\n\n配置CoolingRequirement_X对象：定义散热需求的控制参数\n关键属性：\n\nRequirementId：需求ID\nMonitoringStatus：监控状态\nMonitoringValue：监控值\nFailedValue：失效调速值\nTargetTemperatureCelsius：目标温度\nMaxAllowedTemperatureCelsius：触发全速温度\n\n        \"CoolingRequirement_1_1\": {\n            \"RequirementId\": 1,\n            \"Description\": \"计算板主芯片调速\",\n            \"MonitoringStatus\": \"<=/DPUCard_1.CPUTemperatureCelsius |> expr(($1 == 32767) ? 1 : 0)\",\n            \"MonitoringValue\": \"<=/DPUCard_1.CPUTemperatureCelsius |> expr(($1 == 0 || $1 > 200) ? 40 : ($1 & 255))\",\n            \"FailedValue\": 80,\n            \"TargetTemperatureCelsius\": 90,\n            \"MaxAllowedTemperatureCelsius\": 100,\n            \"ActiveInStandby\": true\n        },\n\n配置CoolingArea_X对象：定义散热风扇的控制参数\n关键属性：\n\nAreaId：调速策略ID\nFanIdxGroup：风扇序号列表\n\n        \"CoolingArea_1_1\": {\n            \"AreaId\": 1,\n            \"RequirementIdx\": 1,\n            \"PolicyIdxGroup\": [],\n            \"FanIdxGroup\": [\n                1,\n                2,\n                3,\n                4\n            ]\n        },\n\n配置Event告警和事件：定义告警和事件的上报规则\n关键属性：\n\nEventKeyId：事件标识ID\nCondition：告警门限值\nHysteresis：迟滞量\nReading：告警读数\nCondition：告警门限值\nOperatorId：判断符号:1：小于 2：小于等于 3：大于 4：大于等于 5：等于 6：不等于 7：上升沿0->1产生，1->0恢复 8：下降沿1->0产生，0->1恢复\nAdditionalInfo：第X个动态参数\nDescArgx：动态参数\n\n        \"Event_PCIeCardPowerOn\": {\n            \"EventKeyId\": \"PCIeCard.PCIeCardOSBootUp\",\n            \"Reading\": \"<=/DPUCard_1.PowerState |> string.cmp($1, 'On') |> expr($1 ? 1 : 0)\",\n            \"ResumeEnable\": 1,\n            \"Condition\": 1,\n            \"OperatorId\": 7,\n            \"Hysteresis\": 0,\n            \"Enabled\": true,\n            \"AdditionalInfo\": \"2,4\",\n            \"DescArg1\": \"\",\n            \"DescArg2\": \"#/Component_DPUCard.Instance\",\n            \"DescArg3\": \"SP923H-VL\",\n            \"DescArg4\": \"system power-on success\",\n            \"Component\": \"#/Component_DPUCard\"\n        },\n\ncsr加载\n在产品仓对应的产品的profile.txt下，配置新增的csr文件，将csr打包到对应的版本，路径信息参考其他产品配置\n2.3 smbus协议介绍\nBMC通过smbus协议与mcu通信，获取DPU卡相关信息\n代码仓\ngeneral_hardware\n代码路径：src/lualib/protocol/std_smbus.lua\n协议配置\n以opcode 0x1005举例：\nfunction std_smbus:GetSystemStatus(data)\n    local recv_data = self:_send_and_receive_request_in_frames({\n        lun = 0x80,\n        arg = 0x00,\n        opcode = 0x1005,\n        offset = 0x00,\n        length = #data,\n        data = data\n    }, 2)\n    return bs.new([[<<type,status>>]]):unpack(recv_data, true)\nend\n\n请求解析\n\n字节顺序\n参数字段\n参数内容\n\n1\nlun/flag\nbit0 - bit6：保留；bit7 = 1：表示最后一帧；bit7 = 0：表示数据未写完；\n\n2\nrequest args\n0x00：v1版本，该参数无效，参数通过request data传递； other：使用此参数，配置内容为对应opcode的TLV定义的Type字段\n\n3-4\nopcode\n操作命令字，不同的命令字有不同的功能和TLV定义\n\n5-8\noffset\n0\n\n9-12\nlength\nrequest data的长度\n\n13-N\nrequest data\n仅在request args为0的时候需要配置，配置内容为对应opcode的TLV定义的Type字段\n\n响应解析\n当前对于smbus协议的响应，在_send_and_receive_request_in_frames方法中已进行部分解析，将response data返回，用户只需要unpack response data即可\n\n字节顺序\n参数字段\n参数内容\n\n1-2\nerror_code\n0：成功；其他为错误码；\n\n3-4\nopcode\n操作命令字，与请求的操作命令字一致\n\n5-8\ntotal_length\nresponse长度\n\n9-12\nlength\n数据长度\n\n13-N\nresponse data\nrequest args为0时，字段含义如下：BYTE[0]：运行状态1的Type，BYTE[1]：运行状态1的Value；request args非0时，BYTE[0]：request args对应TLV定义的Value字段\nlinks: #p-3228-h-1, #p-3228-h-2, #p-3228-h-3, #p-3228-h-1bf-4, #p-3228-h-11-5, #p-3228-h-12-6, #p-3228-h-7, https://gitcode.com/openUBMC/vpd, #p-3228-csr-8, #p-3228-csr-9, #p-3228-h-13-ncsi-10, #p-3228-h-11, https://gitcode.com/openUBMC/network_adapter, #p-3228-h-12, #p-3228-h-2dpu-13, #p-3228-h-21-14, #p-3228-h-22-15, #p-3228-csr-16, #p-3228-csr-17, #p-3228-h-23-smbus-18, #p-3228-h-19, https://gitcode.com/openUBMC/general_hardware, #p-3228-h-20, #p-3228-h-21, #p-3228-h-22",
    "topic_user_name": "Gerard Jay X7t7x",
    "best_answer_url": "",
    "reply_posts": [
        {
            "user_name": "张雨博",
            "topic_closed": null,
            "is_solution": false,
            "post_url": "/t/topic/1389/2",
            "text": "对于CSR的配置，建议利用markdown的代码块代替截图"
        }
    ]
}