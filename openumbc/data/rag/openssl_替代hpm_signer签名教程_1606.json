{
    "topic_id": 1606,
    "question": "openssl 替代hpm_signer签名教程 - content: 下面是一份在 OpenSSL 3.0.11 环境下，针对已有 CMS 签名（CAdES-BES Detached）进行 RFC 3161 时间戳签名的完整操作教程。step.cms：基础 Detached CMS（含 SignedAttributes）\n\nuboot.bin：原始数据\nsigner.pem：固件签名者证书与私钥（PEM 格式，二合一或分离）\ntsa.cnf：本地 TSA 配置（包含 [tsa] 和 [tsa_configX] 区段）\nts_signer.pem：TSA 证书与私钥（PEM 格式）\n\n一、生成基础签名（步骤①–⑥）\n如果你尚未生成 step.cms，请先执行以下命令：\nopenssl cms -sign \\\n  -binary \\               # 处理二进制数据，无文本封装\n  -cades \\                # 自动添加 CAdES-BES 所需的 signingCertificateV2\n  -nosmimecap \\           # 禁止添加 S/MIME capability 扩展\n  -signer signer.pem \\    # 签名者证书（可与私钥合并）\n  -inkey signer.pem \\     # 对应私钥\n  -in    uboot.bin \\      # 原始数据文件\n  -md    sha256 \\         # 指定摘要算法为 SHA-256\n  -out   step.cms \\       # 输出 CMS 文件\n  -outform DER             # 输出 DER 格式（非 PEM）\n\nDETACHED：CMS 不包含原文，只存签名和属性，适用于大文件或流式签名；\nCAdES-BES：-cades 会自动添加 id_smime_aa_signingCertificateV2，以绑定签名证书；\n这一步完成后，step.cms 已含有以下 SignedAttributes：\n\ncontentType：标记被签名的内容类型（pkcs7-data）\nsigningTime：签名时间戳\nmessageDigest：原文摘要\nsigningCertificateV2：签名证书标识（ESSCertIDv2）\n\n二、提取签名值（步骤⑦ 前置）\nRFC 3161 要对签名值本身（即 SignerInfo.signature），而非原文，再做一次哈希并请求时间戳。\n\n定位签名值偏移：\nopenssl asn1parse -inform DER -in step.cms > asn1.txt\ngrep -n \"prim:.*BIT STRING\" asn1.txt\n\n这会列出所有 BIT STRING 项。\n通常会看到两处：一处是证书自身签名，另一处长度 ~513 字节，即 SignerInfo.signature。\n记下该行前的偏移值（如 1062）。\n\n抠出签名值：\nopenssl asn1parse -inform DER -in step.cms \\\n  -strparse 1062 -out sig.bin -noout\n\n-strparse <offset>：从指定偏移提取 ASN.1 对象原始二进制。\nsig.bin 即纯粹的签名 OCTET STRING。\n\n确认签名值正确：\nopenssl dgst -sha256 sig.bin\n# 输出示例： SHA2-256(sig.bin)= 33045f0076db62...\n\n也可与后续时间戳校验对照用。\n\n三、生成时间戳请求 TSQ（步骤⑦）\nopenssl ts -query \\\n  -config tsa.cnf \\      # 加载本地 TSA 配置（[tsa] 段）\n  -data      sig.bin \\  # 待时间戳的二进制数据（签名值）\n  -sha256 \\             # 摘要算法\n  -cert \\               # 请求返回 TSA 证书链\n  -tspolicy  1.2.3.4.1 \\ # 指定策略 OID，对应 tsa.cnf 中 default_policy\n  -out       sig.tsq     # 输出时间戳请求\n\nTSQ（.tsq）是符合 RFC 3161 格式的时间戳请求。\n\n四、 TSA 签发 TSR（步骤⑧）\n本地TSA.cnf签发TSR\nopenssl ts -reply \\\n  -config    tsa.cnf \\    # 同样加载 TSA 配置\n  -inkey     ts_signer.pem \\ # TSA 私钥\n  -signer    ts_signer.pem \\ # TSA 证书\n  -queryfile sig.tsq \\       # 上一步生成的请求\n  -out       sig.tsr          # 输出时间戳响应\n\n若出现 Warning: could not open file ./serial...，可执行：\necho 01 > serial\n\nsignserver TSA模块签发TSR\ncurl -k  -H \"Content-Type: application/timestamp-query\"  --data-binary \"@sig.tsq\"  \"https://192.168.13.118/signserver/process?workerId=3\" -o sig.tsr\n\n可选验证：\nopenssl ts -verify \\\n  -in     sig.tsr \\     # 时间戳响应\n  -data   sig.bin \\     # 原始签名值\n  -sha256 \\             # 摘要算法\n  -CAfile rootca.pem  # TSA 根证书\n&& echo \"TimeStampToken 验证通过\"\n\n五、将 TimeStampToken 注入 CMS（步骤⑨）\n方法 ：C 程序（调用 OpenSSL API，详见下方）\n如下是注入CMS的C代码\ntimestamp_inject.txt (3.5 KB)\ngcc -std=c11 timestamp_inject.c -o timestamp_inject \\\n    $(pkg-config --cflags --libs openssl)\n./timestamp_inject step.cms sig.tsr uboot.bin.cms\n\n六、验证最终结果\n\n主体签名验证（Detached）：\nopenssl cms -verify -binary -inform DER -in uboot.bin.cms -content uboot.bin -certfile signer.pem -CAfile rootca.pem -purpose any -no_attr_verify -out /dev/null && echo \"主体签名 OK\"\n\n总结\n本文档对①-⑨全流程做了深入解释：\n\n基础 CAdES-BES Detached 签名\n提取签名值\n构建时间戳请求\n本地 TSA 签发响应\n将 TimeStampToken 注入 unsignedAttrs\n验证签名与时间戳\nlinks: #p-3892-h-1, #p-3892-h-2, #p-3892-tsq-3, #p-3892-tsa-tsr-4, #p-3892-tsacnftsr-5, #p-3892-signserver-tsatsr-6, #p-3892-timestamptoken-cms-7, #p-3892-c-openssl-api-8, /uploads/short-url/3eH61VCxmOTdpMjbVa30lBzRfgM.txt, #p-3892-h-9, #p-3892-h-10",
    "topic_user_name": "shenwei 百信信息技术",
    "best_answer_url": "",
    "reply_posts": []
}