{
    "topic_id": 1397,
    "question": "BMC运行可观测能力可视化后端搭建指导 - content: 前言\n使用observability组件开启可观测功能后，需要有对应的接收端来接收可观测数据才能数据可视化的目的。本指导用于介绍如何搭建otelcol接收端，以及zipkin、Prometheus、elasticsearch和kibana等可视化后端\n\n注意：上述可视化后端搭建均需先安装java jdk环境\n\n一、 Otelcol接收端\n基本介绍\notelcol全称为opentelemetry-collector，用于接收可观测数据，当前作为对接BMC可观测功能唯一的接收端，BMC发送的可观测数据都需要otelcol进行接收，然后再由otelcol转发到不同的可视化后端\n搭建指南\n\n从opentelemetry获取到最新的opentelemetry-collector工具，选择otelcol-contrib前缀的工具进行使用，如Windows系统可选择 otelcol-contrib_0.128.0_windows_amd64.tar.gz\n\n下载后进行解压缩得到可执行文件otelcol-contrib.exe\n\n新建config.yaml文件，输入以下内容：\n\nreceivers:\n  otlp:\n    protocols:\n      http:\n        endpoint: \"0.0.0.0:6666\"\n        tls:\n          client_ca_file: test_CA.pem\n          cert_file: test_SERVER.pem\n          key_file: test_SERVER_key.pem\n\nexporters:\n  debug:\n    verbosity: detailed\n  \nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      exporters: [debug]\n    metrics:\n      receivers: [otlp]\n      exporters: [debug]\n    logs:\n      receivers: [otlp]\n      exporters: [debug]\n\n各个字段含义解释：\nreceivers为数据接收端，当前使用的是otlp格式，协议采用http发送\nendpoint为接收端地址与端口，本地搭建可以写0.0.0.0，端口号与BMC的可观测页面设置的端口号保持一致\ntls为开启TLS认证，当前BMC默认需要使用TLS传输可观测数据，因此otelcol必须配置该选项\nclient_ca_file为CA证书路径，用于双向认证中otelcol校验BMC证书\ncert_file为服务器证书路径，用于BMC的CA证书校验otelcol证书\nkey_file为服务器证书私钥路径\n\nBMC默认开启单向认证，因此otelcol必须要配置cert_file属性和key_file属性；如果开启双向认证，那么需要配置client_ca_file属性\n\nexporters为数据导出器，用于表示数据需要导出到哪里\ndebug表示将otelcol接收到的可观测数据输出到终端\nverbosity为输出信息的等级\nservice为配置traces、metrics和logs数据使用的receiver和exporter\n\n当前receiver只有otlp，用于调试的话，exporter统一写为debug，那么otelcol接收到的可观测数据都会显示在终端上\n\n启动otelcol\n执行.\\otelcol-contrib.exe --config config.yaml命令即可启动otelcol\n\n如果提示某个端口号被占用，可以使用netstat -ano | findstr :xxxx查看该端口号占用的程序，然后关掉对应程序后再次启动otelcol\n\n二、 Zipkin可视化后端\nZipkin用于接收traces的可视化数据，安装方法可以通过Zipkin官网介绍进行参考\n搭建指南\n\n方案一：使用docker搭建，需要先安装docker，此处不赘述，可从docker官网下载进行安装\n安装完成后在终端执行docker run -d -p 9411:9411 openzipkin/zipkin，冒号前的端口号可以修改，冒号后的端口号固定为9411\n\n方案二：选择下载源码进行本地构建，按照Zipkin官网中 Running from Source的步骤进行安装\n\n修改otelcol的配置文件\n新增配置如高亮部分所示，ip填写zipkin所在的IP地址，port填写zipkin使用的端口号，使otelcol发送traces数据到zipkin后端，重启otelcol生效\n\nexporters:\n  debug:\n    verbosity: detailed\n  zipkin:\n    endpoint: \"http://ip:port/api/v2/spans\"\n  \nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      exporters: [debug, zipkin]\n\n访问http://ip:port即可访问到zipkin的页面，如果使用docker搭建，则ip为docker所在地址，port为docker启动zipkin的端口\n\n点击设置指定查询时间范围，再点击查询即可获取到对应时间范围内的traces数据\n查询/设置按键401×124 10.8 KB\n\n三、 Elasticsearch与kibana可视化后端\nElasticsearch与kibana需要搭配使用，用于接收logs数据，elasticsearch用于接收，kibana用于将数据显示到web页面中\n搭建指南\n\n下载elasticsearch与kibana可执行程序\n\n解压elasticsearch之后，执行bin\\elasticsearch.bat进行首次启动\n\nElasticsearch首次启动时，需要记录密码和token\n第二次启动时将不会显示密码，只能通过重置密码进行获取\ntoken用于kibana配置使用，半小时内有效，半小时后未配置kibana的话需要重新生成token\n\n解压kibana之后，执行bin\\kibana.bat进行首次启动，看到如图所示即为启动成功\n\n访问上一步获取的链接进行页面登录\n输入框输入刚刚启动elasticsearch生成的token，然后点击配置，然后等待配置完成即可\n\n输入用户名与密码，用户名默认输入elastic\n\n点击左侧菜单栏->Observability->Overview\n\n点击show logs查看上报的logs数据\nshow logs按键243×192 7.48 KB\n\n修改otelcol的配置文件\n新增配置如高亮部分所示，ip填写zipkin所在的IP地址，port填写zipkin使用的端口号，使otelcol发送traces数据到zipkin后端，重启otelcol生效\n\nexporters:\n  debug:\n    verbosity: detailed\n  elasticsearch:\n    endpoint: \"https://localhost:9200\"\n    user: \"elastic\"\n    password: \"your password\"\n    tls:\n      ca_file: http_ca.crt\n  \nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      exporters: [debug, elasticsearch]\n\nendpoint默认填写https://localhost:9200，由于kibana与elasticsearch必须使用TLS认证，因此需要添加tls配置\nca_file用于otelcol与elasticsearch进行认证，证书由elasticsearch首次启动生成，存放路径为elasticsearch目录下的config/certs，将ca证书复制到otelcol目录下即可\nuser填写登录用户名\npassword填写登录密码\n证书376×131 12.6 KB\n\n完成后即可在elasticsearch页面查看接收到的logs数据\n\n四、 Prometheus可视化后端\nPrometheus用于接收metrics数据\n搭建指南\n\n获取可执行程序，可从官网进行下载\n\n解压后修改prometheus.yml文件\n将scrape_configs部分进行修改，其中job_name可以替换为想要的名称，targets需要填写Prometheus所在的ip地址，端口号不能与49090相同，需要写另一个未使用的端口，如49091\n\nscrape_configs:\n  - job_name: \"otelcol\"\n    static_configs:\n      - targets: [\"127.0.0.1:49091\"]\n\n启动Prometheus\n执行./prometheus --web.enable-otlp-receiver  --web.listen-address=0.0.0.0:49090 --config.file=prometheus.yml进行启动，其中49090端口不要修改\n\n修改otelcol配置，增加高亮部分，重启生效\n\nexporters:\n  debug:\n    verbosity: detailed\n  prometheus:\n    endpoint: \"127.0.0.1:49091\"\n    namespace: \"otelcol\"\n  \nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      exporters: [debug, prometheus]\n\n登录http://localhost:49090访问Prometheus页面，进行metrics数据查询\nlinks: #p-3246-h-1, #p-3246-otelcol-2, #p-3246-h-3, #p-3246-h-4, https://github.com/open-telemetry/opentelemetry-collector-releases/releases, #p-3246-zipkin-5, https://zipkin.io/pages/quickstart.html, #p-3246-h-6, https://zipkin.io/pages/quickstart.html, https://discuss.openubmc.cn/uploads/default/original/2X/2/24a8f22c2adfe63ba435ff86de55f5bf7d314fdb.png, #p-3246-elasticsearchkibana-7, #p-3246-h-8, https://www.elastic.co/downloads/elasticsearch, https://www.elastic.co/downloads/kibana, https://discuss.openubmc.cn/uploads/default/original/2X/f/fb0006bf262385315792ac3cbceaec1e6ffc1393.png, https://discuss.openubmc.cn/uploads/default/original/2X/e/ee86fcd1a025412ec0a3ea30fc815413471f1477.png, #p-3246-prometheus-9, #p-3246-h-10, https://prometheus.io/download/",
    "topic_user_name": "Zhangyu",
    "best_answer_url": "",
    "reply_posts": []
}