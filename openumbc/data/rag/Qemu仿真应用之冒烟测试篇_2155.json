{
    "topic_id": 2155,
    "question": "Qemu仿真应用之冒烟测试篇 - content: Qem使用指南: 指导如何一步步使用qemu\nQemu仿真应用之模拟事件篇: 指导如何模拟触发事件告警\nQemu仿真应用之新增板块篇：指导如何替换板卡\n现在，跟各位朋友一起来学习如何将qemu用于冒烟测试\nQemu冒烟测试\n常见的冒烟测试都是运行在流水线上，但其实冒烟测试也可以运行在本地。在这里，我将会从如何在流水线上搭建qemu冒烟测试和在本地搭建qemu冒烟测试两个维度进行\n冒烟测试框架\nopenUBMC冒烟测试是基于Robot Framework为基底，采用北向接口（cli、web、redfish和ipmi）来调用和测试openUBMC组件。\n测试框架的搭建和用例编写可以参考qemu组件仓的/test/docs，也欢迎各位一起来搭建和完善测试框架和用例\nRobot Framework简介\nRobot Framework 是一个开源的自动化测试框架，主要用于验收测试和自动化流程。它采用关键字驱动和数据驱动的方式，使得测试用例易于编写和维护，适合功能测试、API测试、UI 测试 等场景。\nRobot Framework的特点\n\n关键字驱动：测试用例由可复用的关键字组成，降低编码门槛\n易于扩展：支持 Python、Java 等语言编写自定义库\n跨平台：支持 Windows、Linux、macOS\n丰富的库生态：提供 Selenium、Requests、Appium、SSHLibrary 等扩展库\n支持数据驱动：可以使用 CSV、Excel、数据库等方式管理测试数据\n集成报告 & 日志：自动生成 HTML 报告和日志，方便调试和分析\n\n核心语法\n\n*** Settings ***（配置区） 定义测试套件的全局设置\n*** Variables ***（变量区） 定义全局变量\n*** Test Cases ***（测试用例区） 编写测试用例\n*** Keywords ***（自定义关键字区） 封装可复用的操作\n\n如何快速基于openUBMC的测试框架写一个测试用例\n在这里，以一个ipmi测试用例为例，一步步地完成ipmi测试用例编写\n*** Settings ***\nDocumentation           搭建ipmitool工具所需要的命令和变量\nResource                ../resource.robot\nLibrary                 OperatingSystem\nLibrary                 BuiltIn\n\n*** Keywords ***\nRun External Ipmi Command\n    [Documentation]     使用带外ipmitool工具运行ipmi命令\n    [Arguments]    ${command}\n    ${ipmi_cmd}=    Set Variable    ipmitool -H ${OPENUBMC_HOST} -U ${OPENUBMC_USERNAME} -P ${OPENUBMC_PASSWORD} -p ${IPMI_PORT} -C ${IPMI_C} -I lanplus ${command}\n    Log    Command Input: ${ipmi_cmd}\n    ${rc}    ${output}=    Run And Return Rc And Output    ${ipmi_cmd}\n    RETURN    ${rc}    ${output}\n\n上面是ipmi.robot文件的内容\nkeywords: 关键字区，每个关键字相当于其他语言的函数\n[Documentation]: 描述这个关键字的作用\n[Arguments]: 描述关键字函数的入参，即需要的参数\n${ipmi_cmd}: 构建ipmi命令，例如: ipmitool -H 127.0.0.1 -U Administrator -P Admin@90000 -p 10623 -C 17 raw 0x06 0x01\nLog: 打印日志\nRun And Return Rc And Output: robot framework封装的关键字，用于运行命令，命令执行成功返回0，否则返回非0\n${rc}: 用于标记命令运行与否：命令执行成功返回0，否则返回非0\n${output}: 运行ipmi命令的返回内容\nRETURN: 函数输出\n*** Settings ***\nDocumentation               通过ipmi接口测试openUBMC的设备id\nResource                    ../../test_function/ipmi/ipmi.robot\nLibrary                     OperatingSystem\nLibrary                     BuiltIn\n\nTest Tags                   Ipmi_Device_Id\n\n*** Variables ***\n${input}                    raw 0x06 0x01\n${expected_rc}              ${0}\n${expected_output}          00 00 01\n\n*** Test Cases ***\nGet IPMI Device ID\n    [Documentation]    带认证的IPMI设备ID测试\n    [Tags]  Get_Device_Id\n    ${rc}    ${output}=  Run External Ipmi Command    ${input}\n    Log    Command Output: ${output}\n    Should Be Equal    ${rc}    ${expected_rc}    msg=${output}\n    Should Contain    ${output}    ${expected_output}\n\n一个.robot文件就是一个测试套件，然后\nSettings：一般用来描述整个测试套件的依赖项\n\nDocumentation: 主要是用来描述这个测试套件的用途\nResource: 资源文件，文件类型为.robot或.resource，包括可复用的关键字、变量定义和测试用例\nLibrary: 测试库，文件类型为.py文件或Java库，提供底层实现的函数/类方法\nTest Tags: 套件级标签，可以和单个测试用例的标签结合起来一起定义某个测试用例\n\nVariables：变量区\n一般存放该测试套件所需要的变量，如果很多套件都需要使用某个变量，例如openubmc的账号和密码，建议存放在test_function/resource.robot中，减少参数的使用】\n${input}: ipmi命令的输入\n${expected_rc}: 是否运行ipmi命令成功的标签，0：表示成功运行，非0：表示运行失败\n${expected_output}: 运行ipmi命令成功后的返回值\nTest Cases：测试用例区\n一个.robot文件就是一个测试套件，一个测试套件可以存放多个测试用例，测试用例区用于存放测试用例的\nGet IPMI Device ID：测试用例名称\n[Documentation]：用来描述测试用例的名称\n[Tags]: 这个测试用例的标签\nRun External Ipmi Command：就是ipmi.robot里面的关键字，详细见上面\n断言判断（重要）：\nShould Be Equal：判断${rc}和${expected_rc}是否相同，例如:如果${rc}=0和${expected_rc}=0，则相同\nShould Contain：判断输出${output}是否包含${expected_output}，如果${output} = db 07 00 00 00 01，${expected_output} = 00 00 01,则包含\n更加详细的描述可见：docs/robotframework的测试框架.md和docs/断言判断的种类.md\n冒烟测试流程\n在qemu组件仓的test/smoke_test中主要存放了冒烟测试的代码：\n\nqemu/test/smoke_test/execute.py主要用来存放判断qemu是否连接web成功的代码\n\ndef try_web_access(port):\n    url = \"https://127.0.0.1:{}/UI/Rest/Login\".format(port)\n    retcode = -1\n    session = requests.Session()\n    session.trust_env = False\n    try:\n        with warnings.catch_warnings():\n            warnings.simplefilter(\n                \"ignore\", category=requests.packages.urllib3.exceptions.InsecureRequestWarning)\n            response = session.get(url, timeout=10, proxies={}, verify=False)\n            retcode = response.status_code\n    except requests.exceptions.RequestException as e:\n        pass\n    return retcode == 200\n\n2.qemu/test/smoke_test/install_dependency.py 用来存放安装robot framework依赖项的代码，若您这边采用其他冒烟测试框架，可以直接替换test/requirements.txt即可\ndef install_dependency():\n    # 安装requirements里面的依赖项\n    try:\n        subprocess.run(\n            [\"pip\", \"install\", \"-r\", \"requirements.txt\"],\n            check=True,\n            stdout=subprocess.PIPE,\n            stderr=subprocess.PIPE,\n            text=True,\n        )\n        print(\"✅ 依赖安装成功！\")\n    except subprocess.CalledProcessError as e:\n        print(f\"❌ 依赖安装失败！错误信息：\\n{e.stderr}\")\n        close_qemu()\n        sys.exit(1)\n\nqemu/test/smoke_test/testing.py存放冒烟测试代码\n\n在这里，我们采用两种方式：\n\nOPENUBMC_HOST=xx.xx.xx.xx SSH_PORT= HTTPS_PORT= robot -A test_lists/QEMU_CI  redfish/ ipmi/\n这种方式巧妙利用robot framework的标签特性，只需要在test_lists/QEMU_CI的文件中放入需要测试用例的标签，运行的时候会去自动从测试用例文件中筛选对应的测试用例\n\n# 验证cli命令\n--include Get_Maca_Status_Via_cli\n--include Get_BCU_HW_Info_Via_cli\n--include Get_Network_Adapter_Via_cli\n--include Get_DeviceLocator_Info_Via_cli\n--include Get_BMC_Version_Via_cli\n...\n\nrobot -v OPENUBMC_HOST:xx.xx.xx.xx  redfish  ipmi\n这种方式是运行 redfish  ipmi这两个测试用例文件夹下所有的测试用例\n\n当然，robot framework测试运行方式是多种多样的，具体可以参考qemu/test/README.md\n流水线冒烟测试\n整体流程\n用于manifest仓冒烟测试的流水线示意图\nimage1092×1054 28.5 KB\n\n开发者向manifest仓提交pr\nci门禁会自动将pr和远程的openUBMC的manifest仓合并，生成具有开发者修改的manifest仓\n基于manifest仓采用bingo build -sc qemu构建出qemu仿真镜像包\n结合远程qemu二进制工具拉起在manifest仓拉起qemu\n通过判断web是否连接成功来判断qemu是否启动成功\n若web连接成功，拉起远程测试代码仓，进行冒烟测试\n无论是否成功，都会返回测试报告和关闭qemu\n\n核心代码（更详细代码可以参考ci-repos/manifest/scripts/smoke_test.sh）：\n# 1.prepare env\necho \"======start to prepare env======\"\ncur_path=$(pwd)\n\nchmod +x /root/repo/ci-repos/.common_scripts/common.sh\nsource /root/repo/ci-repos/.common_scripts/common.sh\nprepare_git $1 $2\nprepare_conan $3 $4\nprepare_bingo\nprepare_sdk\n\n# 2. 下载conan缓存\necho \"======conan cache=====\"\nprepare_qemu_cache\n\n# 3. 构建仿真镜像包\necho \"======Start build bmc simulation mirror package=====\"\ncd $cur_path\nbingo build -sc qemu\n\n# 4.运行qemu（后台运行+日志记录）\necho \"======Start running qemu====\"\nrunning_qemu\n\n# 5.下载测试代码\n# 扩展性：未来社区开发者可以替换为自己的自动测试代码仓并在里面执行冒烟测试脚本\necho \"======Download test code====\"\ndownload_testing_code\n\n# 6.进行冒烟测试\n# 冒烟测试脚本是存放在自动测试代码仓的\necho \"======Start smoke testing====\"\nsmoke_testing\n\n流水线效果\nimage1172×1314 65 KB\n本地冒烟测试\n若需要本地运行冒烟测试，您只需要做两件事：\n\n在manifest仓运行qemu：具体可以见Qem使用指南\n拉取qemu组件仓代码，直接执行如下命令:\n\nsh test/smoke_test.sh\nlinks: https://discuss.openubmc.cn/t/topic/636, https://discuss.openubmc.cn/t/topic/1331, https://discuss.openubmc.cn/t/topic/1332, #p-5447-qemu-1, #p-5447-h-2, #p-5447-robot-framework-3, #p-5447-openubmc-4, #p-5447-h-5, #p-5447-h-6, #p-5447-h-7, https://discuss.openubmc.cn/uploads/default/original/2X/b/bc6a0ffa83f1c946c5a3a29cc97e2bb8a0e0ad43.png, #p-5447-h-8, https://discuss.openubmc.cn/uploads/default/original/2X/3/3a1ac4e7dbb70d2db17b5e45cb574e5248a1e050.png, #p-5447-h-9, https://discuss.openubmc.cn/t/topic/636",
    "topic_user_name": "Linwanmin",
    "best_answer_url": "",
    "reply_posts": []
}