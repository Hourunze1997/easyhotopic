{
    "topic_id": 1101,
    "question": "电源适配指导 - content: 一、power_mgmt介绍\n电源管理组件，负责电源基础信息的获取如电压、电流、温度、功率等，提供电源工作模式、睡眠模式的设置与电源固件升级的功能，同时提供异常事件、告警、黑匣子日志等多种方式用于监测电源状态与故障定位\n代码目录结构\ninclude:\n\tdevice_tree:                                            --设备树相关实现\n      adapters:\n        14060876_0000000xxxxxxxxxxxxx                       --14060876_0000000xxxxxxxxxxxxx单板对应adapter实现\n        14100513_0000000xxxxxxxxxxxxx                       --14060876_0000000xxxxxxxxxxxxx单板对应adapter实现\n        14191046_0000000xxxxxxxxxxxxx                       --14060876_0000000xxxxxxxxxxxxx单板对应adapter实现\n        power_mgmt:\n            protocol:\n                monitor:\n                  canbus.lua                                --canbus电源monitor\n                  pmbus.lua                                 --pmbus电源monitor\n                upgrade:\n                  canbus_upgrade.lua                        --canbus电源升级处理\n                  pmbus_upgrade.lua                         --pmbus电源升级处理\n                init.lua                                    --Protocol适配与加载\n                canbus.lua                                  --canbus协议\n                pmbus.lua                                   --pmbus协议 \n            utils.lua                                       --工具函数实现\n        OnePower.lua                                        --OnePower通用实现\n        PsuSlot.lua                                         --PsuSlot通用实现\n\thwproxy:                                                --电源插件相关实现\n\t    plugins:\n\t\t\tpower_mgmt:\n\t\t\t\tinit.lua                                    --电源插件代码\nmanufacture：\n\tmanufacture_app.lua                                     --装备测试项代码\nsrc:\n\tlualib:\n\t\tdevice:                                             --电源对象处理层\n\t\t\tpsu.lua                                         --单个电源处理层\n\t\t\tpsu_slot.lua                                    --单个电源槽位对象处理层\n\t\t\tpower_configuration.lua                         --电源配置对象处理层\n\t\texternal_interface:\n\t\t    handler.lua                                     --存放外部调用接口和全局变量接口\n\t\tmacros:                                             --存放常量\n\t\t    fw_def.lua                                      --固件升级相关常量\n\t\t    log_def.lua                                     --电源日志相关常量\n\t\t    power_mgmt_enums.lua                            --枚举定义\n\t\t    psu_def.lua                                     --电源相关常量\n\t\tadd_event.lua                                       --调用接口生成软件告警\n\t\texport_import_engine.lua                            --配置导入导出\n\t\tgpio_drived.lua                                     --中断信号抓取\n\t\tlog_service.lua                                     --日志收集、aclost事件记录\n\t\tmetric_collect.lua                                  --数据采集\n\t\tparser_cfg.lua                                      --升级包解析文件\n\t\tpower_ipmi.lua                                      --电源ipmi实现\n\t\tpower_mgmt_app.lua                                  --app入口\n\t\tpower_mgmt_bus.lua                                  --全局bus存放（当前无调用）\n\t\tpower_mgmt_utils.lua                                --电源工具函数实现\n\t\tpower_upgrade.lua                                   --电源升级处理\n\t\tpsu_service.lua                                     --所有电源对象处理层\n\t\tsignal.lua                                          --电源升级信号处理\n\t\tsystem_power.lua                                    --电源fru信息定制化配置\n\t\ttask_service.lua                                    --通用任务处理\n\n二、电源识别加载流程\n\n1、自发现识别加载CSR\n2、自发现上树ObejctGroup对象\n3、sd-bus发送InterfaceAdd信号给各个组件\n4、各个组件向自发现请求CSR对象（解析出来的CSR文本）\n5、libmc4lua创建资源树对象\n6、libmc4lua将自发现解析出来的属性赋值给对象\n7、libmc4lua从持久化恢复数据到对象上\n8、libmc4lua把对象注册上树\n9、调用各个组件的addobject回调\n10、执行组件设备树的差异性适配\n11、执行orm初始化回调，对象初始化完成\nimage1184×1070 116 KB\n\n三、电源适配流程\n这里以适配一款pmbus电源为例，首先进行电源CSR的适配\n步骤1—— 电源CSR适配\n首先确认电源模块是插在哪个板子上的，若电源插在扩展版上，则在相应的扩展版的CSR中去进行适配\n1、配置电源在位信息Scanner（通常位于扩展版上）\n这里以配置电源1为例，配置的CSR为14100513_00000001010123456789.sr\n\"Scanner_PS1Pres\": {\n  \"Chip\": \"#/Smc_ExpBoardSMC\",                   #关联的chip\n  \"Offset\": 603981056,                           #偏移\n  \"Size\": 2,                                     #读取数据长度\n  \"Mask\": 1,                                     #位读时有效，从硬件读取数据后与掩码按位与操作\n  \"Type\": 0,                                     #读类型，0：位读，1：块读\n  \"Value\": 255,                                  #读值\n  \"Period\": 2000                                 #扫描周期，单位ms\n}\n\n2、配置电源连接器（通常位于扩展版上）\n这一步用于配置电源加载使用的CSR，这里配置的是电源1加载使用的是CSR（14191046_PSU_0.sr），这里的在位信息使用上一步配置的电源在位状态\n\"Connector_PowerSupply_1\": {\n  \"Bom\": \"14191046\",                            #下级组件Bomid\n  \"Slot\": 1,                                    #当前连接器槽位，用于确认下级组件的槽位信息（必填）\n  \"Position\": 9,                                #当前连接器位置，用于计算下级组件的位置（必填）\n  \"Presence\": \"<=/Scanner_PS1Pres.Value\",       #下级组件在位信息（必填）\n  \"Id\": \"PSU\",                                  #下级组件的组件id\n  \"AuxId\": \"0\",                                 #下级组件的组件Auxid\n  \"Buses\": [                                    #连接器的总线信息，用于传递至下级组件（必填）\n    \"I2c_2\"\n  ],\n  \"SystemId\": 1,                                #连接器下级的SystemId，用于传递至下级组件\n  \"SilkText\": \"psu1\",                           #连接器的丝印信息\n  \"IdentifyMode\": 2,                            #Connector的标志模式（必填）\n  \"Type\": \"Psu\"                                 #Connector的类型\n}\n\n3、配置电源槽位和电源chip（通常位于扩展版上）\n这一步配置槽位信息及电源chip，配置的CSR为14100513_00000001010123456789.sr\n\"PsuSlot_1\": {\n  \"SlotNumber\": 1,                              #槽位号\n  \"Presence\": \"<=/Scanner_PS1Pres.Value\",       #引用电源的在位寄存器\n  \"SlotI2cAddr\": 184,                           #电源槽位i2c地址\n  \"PsuChip\": \"#/Eeprom_PsuChip1\"                #关联电源i2c器件\n},\n\"Eeprom_PsuChip1\": {                                      \n  \"Address\": 184,                               #地址信息       \n  \"AddrWidth\": 1,                               #位宽\n  \"OffsetWidth\": 1,                             #偏移宽度\n  \"ReadTmout\": 30,                              #读取超时时间，单位ms\n  \"WriteTmout\": 30,                             #写入超时时间，单位ms\n  \"RwBlockSize\": 1024                           #分页读写的数据大小，单位Byte\n}\n\n4、配置电源CSR\n这一步进行电源对象的配置，电源对象需要根据电源在位信息变化来加载及卸载，需要在14191046_PSU_0.sr来配置\n\"FruData_Ps\": {\n    \"FruId\": 1,                                 #FruId，1-63会自动分配fruid，默认可以配1\n    \"StorageType\": \"Power\"                      #非标电子标签不做限制\n},\n\"Fru_Ps\": {\n    \"PowerState\": 1,                            #Fru的热插拔状态\n    \"Health\": 0,                                #健康状态\n    \"EepStatus\": 1,                             #EEPROM状态\n    \"Type\": 3,                                  #FRU类型，参考iBMC IPMI接口说明附录\n    \"FruDataId\": \"#/FruData_Ps\"                 #关联frudata对象名\n},\n\"OnePower_0\": {\n    \"SlotNumber\": \"${Slot}\",                    #槽位号（必填）\n    \"Presence\": 1,                              #在位信息（必填）\n    \"Protocol\": \"pmbus\",                        #电源协议\n    \"PhysicalInterface\": \"pmbus_test\",               #物理接口（必填）\n    \"DeviceLocator\": \"PSU${Slot}\",              #物理位置（必填）\n    \"Position\": \"EXU\",                          #容器信息（必填）\n    \"EnvTemperatureCelsius\": 0,                 #单个电源环境温度\n    \"SerialNumber\": \"\",                         #序列号\n    \"OutputState\": 1,                           #电源电压输出状态\n    \"DeepSleepEnabled\": 0,                      #电源深度休眠使能（告警使用）\n    \"OutputPowerWatts\": 0,                      #输出功耗\n    \"InputVoltageFault\": 32768,                 #电压输入状态\n    \"OutputVoltageFault\": 0,                    #电压输出状态\n    \"OutputCurrentFault\": 0,                    #电流输出状态\n    \"FanFault\": 0,                              #风扇状态\n    \"Fan1Fault\": 0,                             #风扇1故障\n    \"Fan2Fault\": 0,                             #风扇2故障\n    \"Failure\": 0                                #电源故障\n    \"OverTemperature\": 0,                       #风扇1故障\n    \"LossOfInput\": 255,                         #过温故障\n    \"RefFrudata\": \"#/FruData_Ps\",               #关联的Frudata对象\n    \"PartNumber\": \"\"                            #部件编码\n}\n\n步骤2——电源设备树适配\n电源设备树主要涉及的对象有OnePower、PsuSlot、Monitor、Protocol，各对象定义和作用如下：\nOnePower\n设备树加载通用模型，与通用逻辑不一致的需要自行在对应的csr目录下补充adapter，通用OnePower在init阶段关联上一级position的同槽位PsuSlot对象，并刷新Fru信息\nimage439×1291 59 KB\nPsuSlot\nPsuSlot所在不同的单板，需要独立配置一份adapter。框架在获取到PsuSlot对象后，会根据所属的csr，拉起不同的adapter\nPsuSlot主要函数逻辑（适配新adapter需要实现）：\n1、fetch_power_supply_info\n注册对应的协议(如pmbus,canbus)，并刷新Fru数据\n2、power_monitor_start\n拉起属性轮询任务\n3、psm_monitor_stop\n停止电源轮询任务\nMonitor\n不同协议的电源在属性查询、轮询周期等实现上有所不同，所以需要对fetch_power_supply_info和power_monitor_start的实现函数提取，不同的任务调度提取出来作为monitor\nMonitor主要函数逻辑（适配新adapter需要实现）：\n1、fetch_power_supply_info\n获取并刷新Fru数据\n2、power_monitor_start()\n启动电源信息监控\n3、stop_monitor_tasks()\n停止电源信息监控\nProtocol\n电源协议，根据不同的电源类型实现，对外屏蔽命令字和逻辑功能实现，接口功能和名称保持一致。\n主要包含：\n\n1、电源功率信息、状态信息、Fru信息的查询\n2、电源黑匣子数据获取\n3、电源模式设置（主备、深度休眠）\n4、电源风扇转速设置\n5、电源升级处理\nimage1276×1036 95.4 KB\n\n1、电源协议Protocol适配与加载\n首先，根据上层传入的physical_interface（即OnePower对象上配置的PhysicalInterface属性），在设备树的init.lua（include/device_tree/adapters/power_mgmt/protocol/init.lua ）文件中定义加载的协议文件，封装monitor(可不配置)\n支持如下两种写法\nphysical_interface = {OnePower对外显示Protocol字段， require xxx文件, monitor的文件路径}\n厂商 = { [型号] = {OnePower对外显示Protocol字段， require xxx文件, monitor的文件路径} } 该写法需要先加载默认协议，由adapter读完厂商型号后，再根据厂商、型号重新加载协议文件\n这里以之前配置的OnePower对象举例，PhysicalInterface配置的是pmbus_test，则需要在init.lua文件中对应配置所使用的protocol和monitor，这里电源协议和monitor都新加了一个文件（如和已有的相同，可以直接复用）\n\n2、设备树adpter适配\n设备树adpter适配主要针对PsuSlot和OnePower对象，组件仓有一份PsuSlot和OnePower的设备树加载通用模型，但如果有差异化的诉求，与通用逻辑不一致，则需要通过在对应的csr目录下补充adapter\n这里以PsuSlot举例，如果想差异性实现代码，则需要新建一个文件夹，文件夹命名和配置的CSR同名，在下面新增对应的PsuSlot文件，框架在加载时，会优先使用和CSR命名匹配的文件夹下对象，其次使用通用的文件\nimage293×485 8.61 KB\n步骤3——调试\n完成以上配置之后，通过命令busctl --user tree bmc.kepler.power_mgmt，可以在资源树上查看到配置的电源对象OnePower，并且可以查看每个电源对象下属性显示是否正常，若显示信息异常，可先通过手动发送命令读取电源信息，若能够读取则设备树代码适配存在问题，否则就是CSR适配存在问题\n手动查询电源信息方式如下，这里以pmbus读取电源1的输入功率为例：\nbusctl --user call bmc.kepler.hwproxy /bmc/kepler/Chip/Eeprom/Eeprom_PsuChip1_0101 bmc.kepler.Chip.BlockIo Read a{ss}uu\n0 151 3\n解释：\n/bmc/kepler/Chip/Eeprom/Eeprom_PsuChip1_0101：对应Chip的资源树路径（根据环境上路径进行调整）\nbmc.kepler.Chip.BlockIo：资源树块读写接口\nRead：方法名\na{ss}uu：请求参数签名，其中a{ss}为上下文可以直接填0，第一个u代表偏移，151对应pmbus获取输入功率命令字，第二个u代表读取字节数，输入功率2字节+crc码，共3个字节\n四、电源固件升级\n\n1、获取协议和升级包匹配的电源\n2、检验电源数是否为0\n3、电源模式切换，防止整机掉电\n4、电源升级顺序排序，按照电源健康度进行排序\n5、按照排序顺序遍历每个电源电源\n6、校验环境是否支持升级\n7、停止电源数据监控\n8、升级单个电源\n9、恢复数据监控并刷新电源固件信息\n10、返回电源升级结果\nimage1840×1237 332 KB\n\n主要函数逻辑：\n1、power_upgrade\n校验电源是否支持升级（电源状态、模式、数量校验）\nis_support_upgrade(psu_obj)\n2、PsuSlot\n升级前后处理（电源监控任务的停止、拉起和电源状态的刷新）及protocol升级处理的调用\npower_upgrade(upgrade_path, upgrade_process)\n3、Protocol\n电源升级处理\nupgrade(upgrade_path, upgrade_process)\n五、常见踩坑点及注意事项\n1、设备树中使用的的类变量需要在ctor中定义出来，否则出现代码中获取为nil的问题\nimage488×417 22.9 KB\nlinks: #p-2357-power_mgmt-1, #p-2357-h-2, #p-2357-h-3, https://discuss.openubmc.cn/uploads/default/original/1X/3d7b5b4ed750cf9b520a6505bc69cc3e402f0210.png, #p-2357-h-4, #p-2357-h-1-csr-5, #p-2357-h-1scanner-6, #p-2357-h-2-7, #p-2357-h-3chip-8, #p-2357-h-4csr-9, #p-2357-h-2-10, https://discuss.openubmc.cn/uploads/default/original/1X/9a4e961232c18a022d6224db670e6f6a15c7ff1f.png, https://discuss.openubmc.cn/uploads/default/original/1X/5611980e88f4ec9622b97f62628fcacb595e65d6.png, #p-2357-h-1protocol-11, #p-2357-h-2adpter-12, https://discuss.openubmc.cn/uploads/default/original/2X/3/383738ca7a226397d611d9466045157bbce46801.png, #p-2357-h-3-13, #p-2357-h-14, https://discuss.openubmc.cn/uploads/default/original/1X/619bd875842a64cc0f4875909e09b8f70681dad7.png, #p-2357-h-15, #p-2357-h-1power_upgrade-16, #p-2357-h-2psuslot-17, #p-2357-h-3protocol-18, #p-2357-h-19, https://discuss.openubmc.cn/uploads/default/original/1X/0ca10de3c9a4b04f13b379701485f6f723812f13.png",
    "topic_user_name": "Fumingquan",
    "best_answer_url": "",
    "reply_posts": [
        {
            "user_name": "张雨博",
            "topic_closed": null,
            "is_solution": false,
            "post_url": "/t/topic/1101/2",
            "text": "content: 本篇文档已上线文档中心，电源适配指南 | openUBMC\n关闭此帖\nlinks: https://www.openubmc.cn/docs/zh/development/develop_guide/feature_development/power_integration.html"
        },
        {
            "user_name": "张雨博",
            "topic_closed": null,
            "is_solution": false,
            "post_url": "/t/topic/1101/3",
            "text": ""
        }
    ]
}