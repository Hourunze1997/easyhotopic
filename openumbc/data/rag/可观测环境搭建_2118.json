{
    "topic_id": 2118,
    "question": "可观测环境搭建 - content: [TOC]\n1 可观测介绍\n可观测是什么？\n可观测性（Observability）让我们可以在不了解系统内部运作逻辑的情况下，从外部理解一个系统，它使我们能够通过系统外部输出的数据来推断其内部状态。\n可观测怎样了解系统？\n可观测性要求系统能够发出信号，包括Trace（追踪）、Metric（指标）和Logs（日志），通过这些信号从不同角度揭示系统的运行状况。\n可观测性的作用？\n可观测特性可帮助进行监控性能、问题诊断和系统优化。\nopenUBMC借助openTelemetry、fluent-bit构建BMC可观测能力，实现指标、日志和跟踪数据的采集和管理。\n1.1 可观测特性使用场景\n可观测特性可帮助社区开发人员基于指标、日志和跟踪数据的可视化能力开展问题定位，例如定位组件flash写入量情况、RPC调用情况、北向接口调用链追踪信息等。\n当前openUBMC可观测能力正在进行持续构建，已支持的可观测指标可参考链接。\n1.2 可观测信号介绍\nMetric（指标） ：系统发生了什么？\n指标是系统的定量数据，用于测量性能或行为，例如CPU使用率、内存消耗、请求速率或错误率。指标通常以时间序列形式呈现，用于监控系统健康状况并分析长期趋势。\nTrace（追踪）：问题出在哪里？\n记录请求在系统中的完整路径，包括请求的起始时间、结束时间以及在各个服务或组件之间的流转情况。追踪能够帮助工程师理解请求的延迟来源、识别性能瓶颈，并调试分布式系统中的复杂问题。\nLogs（日志）：为什么会发生？\n日志是系统或应用程序生成的事件记录，包含详细的文本信息，如错误消息、警告或调试数据。日志对于深入调查问题、审计系统行为以及满足合规性要求至关重要。\n1.3 可观测架构\nflowchart BT\n    %% 定义节点（自下而上）\n    App1[\"业务组件1\"] --OTLP/gRPC--> observability\n    App2[\"业务组件2\"] --OTLP/gRPC--> observability\n    \n    OTEL_SDK[\"openTelemetry SDK\"] --> App1\n    OTEL_SDK --> App2\n\n    observability --OTLP/HTTP--> OTelCollector[\"openTelemetry Collector\"]\n\n    \n    OTelCollector --logs--> ELK[\"ELK stack\"]\n    OTelCollector --metrics--> Prometheus[\"Prometheus\"]\n    OTelCollector --traces--> Zipkin[\"Zipkin\"]\n    OTelCollector --traces--> Jaeger[\"Jaeger\"]\n    \n  \n    %% 分组定义（自下而上）\n    subgraph BMC\n        subgraph observability[\"可观测组件\"]\n            FluentBit[\"fluent-bit\"]\n        end\n        App1\n        App2\n        OTEL_SDK\n    end\n    \n    \n    subgraph 可视化数据转发层\n        OTelCollector\n    end\n    \n    subgraph 可视化平台\n        ELK\n        Prometheus\n        Zipkin\n        Jaeger\n    end\n\n2 环境搭建\n2.1 准备依赖软件包\n\nopentelemetry-collector-contrib：用于接收BMC发送的可观测数据，同时向不同类型的后端可视化系统（Prometheus、Zipkin、Elastic等）转发可观测数据，下载地址\nZipkin：用于接收opentelemetry-collector-contrib发送的Trace类型数据，并进行可视化呈现，下载地址\n\n可选依赖：openjdk，Zipkin以Jar包形式发布，对JDK版本存在依赖，如果部署环境JDK版本较低，需要进行升级，下载地址\n\nPrometheus：用于接收opentelemetry-collector-contrib发送的Metric类型数据，并进行可视化呈现，下载地址\n\n说明：不同Linux环境需要结合CPU架构选择合适的下载包，例如鲲鹏服务器部署OpenEuler系统则需要选择arm64形态软件包。如果仅个人使用，也可以选择windows软件包。\n\n2.2 准备证书/密钥文件\nBMC与后端转发层（Opentelemetry Collector）之间需要支持TLS加密，从而方式可观测数据泄漏，因此在环境搭建之前需要先准备证书。证书可通过XCA工具进行制作。\n2.2.1 安装XCA\n下载XCA安装包\n2.2.2 新建数据库\n点击左上角文件->新建数据库->设置数据库密码\nimage699×513 10.4 KB\n2.2.3 制作CA证书\n（1）创建证书\nimage956×667 28.9 KB\n（2）来源\n一定要点击应用模板扩展信息！\nimage749×672 20.3 KB\n（3）主题\nimage747×640 19.6 KB\n（4）扩展\n证书的有效期要早于服务端以及客户端的系统时间！建议有效期的起始时间设置早一点\nimage747×640 24.5 KB\n创建完成后应有一CA证书\nimage1166×706 32.9 KB\n2.2.4 制作SSL证书\n（1）创建证书\nimage1160×708 33.6 KB\n（2）来源\nimage747×640 19.1 KB\n（3）主题\nimage747×640 19.8 KB\n（4）扩展\n证书的有效期要早于服务端以及客户端的系统时间！建议有效期的起始时间设置早一点\nimage747×640 25.6 KB\n创建完成后应有一CA证书签发的ssl证书\nimage1162×681 35.6 KB\n2.2.5 导出证书\n（1）导出CA证书\n选中CA证书->导出->文件\nimage1159×705 36.4 KB\nimage671×385 12.4 KB\n（2）导出SSL证书\n右键SSL证书->导出->文件\nimage1158×694 35.9 KB\nimage671×385 12.7 KB\n（3）导出SSL私钥\nimage1157×699 18 KB\nimage671×385 9.52 KB\n2.2.6 最终得到的证书和密钥说明\n1）可观测CA证书，用于导入openUBMC\nobservability_CA.crt \n\n2）可观测openTelemetry Collector Contrib证书，用于配置Collector的cert_file参数\nobservability.otelcol.crt\n\n3）可观测openTelemetry Collector Contrib私钥，用于配置Collector的key_file参数\nobservability.otelcol.key.pem\n\n2.3 配置依赖软件\n2.3.1 配置Prometheus\nPrometheus用于接收opentelemetry-collector-contrib发送的Metric类型数据，并对其进行可视化呈现。Prometheus启动依赖配置文件（prometheus.yml）示例如下：\n# my global config\nglobal:\n  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.\n  # scrape_timeout is set to the global default (10s).\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets:\n          # - alertmanager:9093\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  # - \"first_rules.yml\"\n  # - \"second_rules.yml\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.\n  - job_name: \"prometheus\"\n\n    # metrics_path defaults to '/metrics'\n    # scheme defaults to 'http'.\n\n    static_configs:\n      - targets: [\"127.0.0.1:49091\"]  # 监听49091端口，用于接收collector发送的Metric数据\n       # The label name is added as a label `label_name=<label_value>` to any timeseries scraped from this config.\n        labels:\n          app: \"prometheus\"\n\n启动prometheus，通过49092端口对外提供web服务\n./prometheus --web.enable-otlp-receiver  --web.listen-address=0.0.0.0:49092 --config.file=prometheus.yml\n\n2.3.2 配置Zipkin\nZipkin用于接收opentelemetry-collector-contrib发送的Trace类型数据，并对其进行可视化呈现。Zipkin默认不需要额外的配置文件，可直接启动：\njava -jar /root/observability/zipkin-server-3.5.1-exec.jar\n\nZipkin新版本对Java版本存在依赖，需要保证Java版本满足要求。\n\n2.3.3 配置opentelemetry-collector-contrib\n用于接收BMC发送的可观测数据，同时向不同类型的后端可视化系统（Prometheus、Zipkin、Elastic等）转发可观测数据。启动时依赖配置文件（otelcol-config.yaml）如下：\nreceivers: \n  otlp:\n    protocols:\n      http:\n        endpoint: \"0.0.0.0:4318\"  # OTLP over HTTP\n        max_request_body_size: 67108864  # 64MB\n        tls:\n          cert_file: observability.otelcol.crt            # collector证书\n          key_file: observability.otelcol.key.pem   # collector密钥\n\nprocessors:\n  # 批处理器 - 控制数据分批\n  batch:\n    send_batch_size: 1024\n    send_batch_max_size: 2048\n    timeout: 1s\n    \n  # 内存限制器\n  memory_limiter:\n    limit_mib: 512\n    spike_limit_mib: 128\n    check_interval: 5s\n\nexporters:\n  debug:\n    verbosity: detailed\n  prometheus:\n    endpoint: \"127.0.0.1:49091\"\n    namespace: \"otelcol\"\n  elasticsearch:\n    endpoint: \"https://localhost:9200\"\n    user: \"elastic\"\n    password: \"\"\n    tls:\n      ca_file: elasticsearch-9.0.1/config/certs/http_ca.crt\n  zipkin:\n    endpoint: \"http://127.0.0.1:9411/api/v2/spans\"\n  otlp/jaeger:\n    endpoint: https://127.0.0.1:44318\n\nservice:\n  pipelines:\n    metrics:\n      receivers: [otlp]\n      exporters: [debug, prometheus]\n    logs:\n      receivers: [otlp]\n      exporters: [debug]\n    traces:\n      receivers: [otlp]\n      exporters: [debug, zipkin]\n\n启动collector：\notelcol-contrib --config /root/observability/otelcol-config.yaml\n\n2.3.4 一键式启动脚本\n可使用如下一键式脚本拉起otelcol、Zipkin、Prometheus\n#!/bin/bash\n\nPROMETHUES_PATH=/root/observability/promethus-3.5.0.linux-arm64/promethus\nPROMETHUES_PATH=/root/observability/promethus-3.5.0.linux-arm64/promethus\n\nOTELCOL_PATH=/root/observability/otelcol-contrib\nOTELCOL_CONFIG_PATH=/root/observability/otelcol-config.yaml\n\nJAVA_PATH=/root/observability/jdk-17.0.1/bin/java\nZIPKIN_PATH=/root/observability/zipkin-server-3.5.1-exec.jar\n\necho \"Starting OpenTelemetry Collector...\"\nnohup \"$OTELCOL_PATH\" --config \"$OTELCOL_CONFIG_PATH\" 2>/dev/null &\necho \"otelcol started with PID $!\"\n\nsleep 2\necho \"Starting Prometheus...\"\nnohup \"$PROMETHEUS_PATH\" --web.enable-otlp-receiver --web.listen-address=0.0.0.0:49092 --config.file=\"$PROMETHEUS_CONFIG_PATH\" 2>/dev/null &\necho \"Prometheus started with PID $!\"\n\nsleep 2\necho \"Starting Zipkin...\"\nnohup \"$JAVA_PATH\" -jar \"$ZIPKIN_PATH\" 2>/dev/null &\necho \"Zipkin started with PID $!\"\n\necho \"All observability services have been started.\"\n\n2.4 BMC配置\n点击BMC WEB页面，进入到维护诊断->可观测进行配置：\nStep1：使能可观测服务\nStep2：选择TLS模式（调试场景建议选择单向认证，方便配置）\nStep3：配置接收端证书，即配置opentelemetry-collector-contrib的根证书，点击跳转到证书页面进行配置\nStep4：配置接收端信息，即配置opentelemetry-collector-contrib服务的IP地址、端口号，同时使能该接收端\nimage2362×540 22.1 KB\n3 访问可视化系统\n3.1 Zipkin查看Trace数据\n可通过http://{ip}:9411方式登录Zipkin UI界面\nimage2545×345 16.8 KB\n3.2 Prometheus查看Metric数据\n可通过http://{ip}:49092方式登录Prometheus UI界面\nimage2554×480 16.1 KB\n常见问题\n\nQ：配置完成后服务已启动，但是无法访问\nA：可能由于防火墙原因，可先关闭防火墙systemctl stop firewalld\nlinks: #p-5290-h-1-1, #p-5290-h-11-2, https://discuss.openubmc.cn/t/topic/1516, #p-5290-h-12-3, #p-5290-h-13-4, #p-5290-h-2-5, #p-5290-h-21-6, https://github.com/open-telemetry/opentelemetry-collector-releases/releases, https://search.maven.org/remote_content?g=io.zipkin&a=zipkin-server&v=LATEST&c=exec, https://mirrors.huaweicloud.com/openjdk/17.0.1/, https://prometheus.io/download/, #p-5290-h-22-7, #p-5290-h-221-xca-8, https://hohnstaedt.de/xca/index.php/download, #p-5290-h-222-9, https://discuss.openubmc.cn/uploads/default/original/2X/4/4e28f82c4c41003e38e88a15d838109c05ec9383.png, #p-5290-h-223-ca-10, https://discuss.openubmc.cn/uploads/default/original/2X/3/30aa3d5beed7badb0d4c0f33de46474a4258f965.png, https://discuss.openubmc.cn/uploads/default/original/2X/2/29bed5a981e08793334640a1adc70eb3ed2a11a1.png, https://discuss.openubmc.cn/uploads/default/original/2X/e/e56dcab56c930f87df495dc6d060d26adc06a213.png, https://discuss.openubmc.cn/uploads/default/original/2X/2/21f5b4b19929c7b68b5388aea4b4e3f0637b146e.png, https://discuss.openubmc.cn/uploads/default/original/2X/9/9edb461a402fb61da026e11b207f07db0881179d.png, #p-5290-h-224-ssl-11, https://discuss.openubmc.cn/uploads/default/original/2X/4/4f1f401c62eb31fcd28573cf7396ee6bf2b0b1ab.png, https://discuss.openubmc.cn/uploads/default/original/2X/d/dbc289bc3cb6badee072eb7613a993704c2fb12a.png, https://discuss.openubmc.cn/uploads/default/original/2X/6/6f0960a63f6e67e6ab7a2d25cbace644193ad605.png, https://discuss.openubmc.cn/uploads/default/original/2X/d/df09d076ef3fbc5ab193c6cd58fc58609ffceaa9.png, https://discuss.openubmc.cn/uploads/default/original/2X/b/bf8babc5bd98eb84a98a09ec574cc762d572c834.png, #p-5290-h-225-12, https://discuss.openubmc.cn/uploads/default/original/2X/7/7edb9c2c0562f5a7272ab0eb0e4fdab8ed3b81dc.png, https://discuss.openubmc.cn/uploads/default/original/2X/4/452ccb057c3223daec375215710a2b9c6a049b27.png, https://discuss.openubmc.cn/uploads/default/original/2X/4/4ba7026853544df38d25620bbc0e03dc17d0ce51.png, https://discuss.openubmc.cn/uploads/default/original/2X/0/038a5aa74871e8ebeb5040e5b2bb9d2eeb3f72f5.png, https://discuss.openubmc.cn/uploads/default/original/2X/4/45a13330ba0ebb57259fcecfb6244a35354f76a4.png, https://discuss.openubmc.cn/uploads/default/original/2X/d/dc7c80c06035f01256314ad304378ce9e1c2b7db.png, #p-5290-h-226-13, #p-5290-h-23-14, #p-5290-h-231-prometheus-15, #p-5290-h-232-zipkin-16, #p-5290-h-233-opentelemetry-collector-contrib-17, #p-5290-h-234-18, #p-5290-h-24-bmc-19, https://discuss.openubmc.cn/uploads/default/original/2X/3/3f3832edd6f542989d44238ef15c25cad52a8a79.png, #p-5290-h-3-20, #p-5290-h-31-zipkintrace-21, https://discuss.openubmc.cn/uploads/default/original/2X/2/29693cb18d837a7fb663c12528fbcfafc469bf11.png, #p-5290-h-32-prometheusmetric-22, https://discuss.openubmc.cn/uploads/default/original/2X/a/a4e0dcea917073ce87d8034d3e341766ff1f1941.png, #p-5290-h-23",
    "topic_user_name": "lisiguang",
    "best_answer_url": "",
    "reply_posts": [
        {
            "user_name": "百信-罗昊",
            "topic_closed": null,
            "is_solution": false,
            "post_url": "/t/topic/2118/2",
            "text": "建议增加一下该功能的使用场景说明，以及展示一下UI界面内容，看得有点懵"
        },
        {
            "user_name": "lisiguang",
            "topic_closed": null,
            "is_solution": false,
            "post_url": "/t/topic/2118/3",
            "text": "帖子尚未完善，稍后会补充贴图"
        }
    ]
}